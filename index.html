<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>飲料配方選擇題</title>
<style>
  :root{
    --card:#ffffffee;
    --muted:#6b7280;
    --ok:#11b381;
    --ok-bg:#eafaf0;
    --bad:#e74c3c;
    --bad-bg:#fdecea;
    --radius:14px;
  }
  html,body{height:100%;margin:0;font-family:system-ui,"PingFang TC","Noto Sans TC",sans-serif;color:#111}
  /* 背景：淡入淡出幻燈片 + 白色漸層遮罩，避免吃字 */
  #bg, #bg::after{
    position:fixed; inset:0; z-index:-2; background-position:center; background-size:cover; transition:opacity 1s ease;
  }
  #bg{opacity:1}
  #bg.fade{opacity:0}
  #bgMask{position:fixed; inset:0; z-index:-1;
    background:linear-gradient(180deg, rgba(255,255,255,.88) 0%, rgba(255,255,255,.88) 28%, rgba(255,255,255,.85) 45%, rgba(255,255,255,.84) 62%, rgba(255,255,255,.82) 100%);
    pointer-events:none;
  }

  /* 版頭工具列（桌機保持原排版） */
  .shell{max-width:1080px;margin:26px auto;padding:0 16px}
  .toolbar{background:var(--card);backdrop-filter:blur(6px);border:1px solid #e5e7eb;border-radius:var(--radius);padding:16px 18px;display:flex;flex-wrap:wrap;gap:12px;align-items:center}
  h1{flex:1 1 100%;text-align:center;margin:0 0 12px;font-size:26px;letter-spacing:2px}
  .tools{display:flex;gap:10px;align-items:center;flex-wrap:wrap;width:100%}
  label{color:#374151}
  select,button{font-size:16px;padding:10px 14px;border-radius:12px;border:1px solid #d1d5db;background:#fff;cursor:pointer}
  .btn{background:#fff}
  .btn-primary{background:var(--ok);border-color:#0f9e72;color:#fff}
  #metaTop{margin-left:auto;color:var(--muted)}

  /* LOGO 固定左上 */
  #cornerLogo{position:fixed; left:18px; top:10px; width:72px; z-index:10; user-select:none; pointer-events:none}

  /* 規則卡片 */
  .rules{background:var(--card);border:1px solid #e5e7eb;border-radius:var(--radius);padding:16px 18px;margin-top:12px}
  .rules p{margin:8px 0}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #cbd5e1}
  .badge.ok{background:#e7f8f1;color:#0f9e72;border-color:#b5ead6}
  .badge.bad{background:#ffecec;color:#c23b2a;border-color:#ffc9c9}

  /* 題卡 */
  .card{background:var(--card);border:1px solid #e5e7eb;border-radius:var(--radius);padding:18px;margin-top:16px}
  #qtitle{font-size:20px;font-weight:700;margin:6px 0 12px}
  .option{border:1px solid #d8dee6;border-radius:12px;padding:11px 14px;margin:8px 0;display:flex;align-items:center;gap:10px}
  .option input{transform:scale(1.1)}
  .option label{flex:1;color:#111} /* 字色固定黑色 */
  .option.correct{border-color:var(--ok);background:var(--ok-bg)}
  .option.wrong{border-color:var(--bad);background:var(--bad-bg)}
  .option.missed{border:2px solid var(--bad)} /* 沒選到但正確：紅框 */
  #explain{margin-top:10px;color:#444}
  #scoreline{font-weight:700;margin-bottom:4px} /* 兩行：本題得分 + 完整配方 */
  .card-actions{display:flex;gap:10px;margin-top:12px}
  .card-actions .btn{border:1px solid #d1d5db}
  .card-actions .btn-primary{border-color:#0f9e72}

  /* 結果卡片 */
  #summary{display:none;margin-top:16px;background:var(--card);border:1px solid #e5e7eb;border-radius:var(--radius);padding:16px}
  #summary b{font-size:22px}

  /* —————————— 手機優化：不動桌機，<=640px 自動套用 —————————— */
  @media (max-width:640px){
    #cornerLogo{left:12px; top:8px; width:58px}
    .toolbar{padding:12px}
    h1{font-size:22px;margin:0 0 8px;letter-spacing:1.5px}

    /* 工具列變 3 欄： [題型下拉] [開始] [進度|得分] */
    .tools{display:grid; grid-template-columns:minmax(0,1fr) auto auto; align-items:center; gap:8px}
    .tools > .left{display:flex; align-items:center; gap:8px; min-width:0}
    .tools > .left > label{display:none}             /* 手機藏掉「題型：」文字節省空間 */
    #mode{font-size:14px; padding:8px 10px; max-width:60vw; min-width:40vw}
    #startBtn{font-size:14px; padding:8px 12px; white-space:nowrap}
    #metaTop{font-size:12px; white-space:nowrap; justify-self:end; margin-left:0}

    .rules p{margin:12px 0}                          /* 規則三行間距再開一些 */
    .card{padding:14px}
    #qtitle{font-size:18px}
    .option{padding:10px 12px}
    .option label{font-size:15px}
  }
</style>
</head>
<body>
  <img id="cornerLogo" src="logo.png" alt="logo">
  <div id="bg"></div>
  <div id="bgMask"></div>

  <div class="shell">
    <div class="toolbar">
      <h1>飲料配方選擇題</h1>
      <div class="tools">
        <div class="left">
          <label for="mode">題型：</label>
          <select id="mode">
            <option value="mixed">混合（多選成分＋用量）</option>
            <option value="amount">用量題（問某成分幾 cc/g/匙/罐）</option>
            <option value="ingredientAll">成分題（多選：選出所有正確成分）</option>
          </select>
        </div>
        <button id="startBtn" class="btn btn-primary">開始測驗</button>
        <div id="metaTop">進度：0/20｜得分：0/100</div>
      </div>
    </div>

    <div class="rules" id="rules">
      <p>規則：20 題，每題 5 分。</p>
      <p>多選題評分：每題滿分 5 分，正確選一項得 <b>5 / 正確數</b> 分；每多選一個錯誤扣同額（最低 0 分）。</p>
      <p>標示：<span class="badge ok">綠底＝正確成分</span>
        　<span class="badge bad">紅框＝勾錯或漏選</span></p>
    </div>

    <div class="card" id="card" style="display:none">
      <div id="qtitle"></div>
      <div id="options"></div>

      <!-- 本題得分 & 完整配方：分兩行 -->
      <div id="explain" style="display:none">
        <div id="scoreline"></div>
        <div id="formula"></div>
      </div>

      <div class="card-actions">
        <button id="submitBtn" class="btn btn-primary">送出答案</button>
        <button id="nextBtn" class="btn">下一題</button>
      </div>
    </div>

    <div id="summary"></div>
  </div>

<script>
/* ================= 背景輪播（需要 bg1.jpg ~ bg6.jpg 與 logo.png 與本檔同層） ================= */
(function(){
  const imgs = ["bg1.jpg","bg2.jpg","bg3.jpg","bg4.jpg","bg5.jpg","bg6.jpg"];
  let idx = 0, bg = document.getElementById('bg');
  function show(i){
    bg.classList.add('fade');
    setTimeout(()=>{ bg.style.backgroundImage = `url('${imgs[i]}')`; bg.classList.remove('fade'); }, 300);
  }
  show(0);
  setInterval(()=>{ idx = (idx+1)%imgs.length; show(idx); }, 6000);
})();

/* ================== 題庫（你提供的最新版本，已去除「糖／加糖／茶」泛詞） ================== */
const lines = `
錫蘭紅茶｜紅茶；（糖鍵紅茶鍵）
茉香綠茶｜綠茶；（糖鍵原茶鍵）
文山青茶｜青茶；（糖鍵原茶鍵）
玄米煎茶｜玄米；（糖鍵原茶鍵）
碳焙鐵觀音｜鐵觀音；（糖鍵原茶鍵）
冬瓜茶｜冬瓜茶；（不額外加糖）

柳橙百香綠（Ｌ）｜柳橙100cc + 百香20cc + 綠茶；（糖鍵柳橙鍵）
柳橙百香綠（Ｍ）｜柳橙80cc + 百香15cc + 綠茶；（糖鍵柳橙鍵）
奇異果綠茶｜奇異果150g + 檸檬5cc + 綠茶；（糖鍵奇異果綠茶鍵）
鮮榨葡萄柚綠（Ｌ）｜葡萄柚160cc + 綠茶；（糖鍵葡萄柚鍵）
鮮榨葡萄柚綠（M）｜葡萄柚120cc + 綠茶；（糖鍵葡萄柚鍵）
鮮榨葡萄柚青（Ｌ）｜葡萄柚160cc + 青茶；（糖鍵葡萄柚鍵）
鮮榨葡萄柚青（M）｜葡萄柚160cc + 青茶；（糖鍵葡萄柚鍵）

百香奇亞籽｜奇亞籽 + 百香30cc + 檸檬5cc + 紅茶100cc + RO；（糖鍵百香鍵）
檸檬奇亞籽｜奇亞籽 + 檸檬30cc + 紅茶100cc + RO；（糖鍵檸檬鍵）
柳橙奇亞籽｜奇亞籽 + 柳橙120cc + 紅茶100cc + RO；（糖鍵柳橙鍵）

翡翠檸檬紅（Ｌ）｜檸檬40cc + 紅茶；（糖鍵檸檬鍵）
翡翠檸檬紅（M）｜檸檬30cc + 紅茶；（糖鍵檸檬鍵）
翡翠檸檬綠（Ｌ）｜檸檬40cc + 綠茶；（糖鍵檸檬鍵）
翡翠檸檬綠（M）｜檸檬30cc + 綠茶；（糖鍵檸檬鍵）
翡翠檸檬青（Ｌ）｜檸檬40cc + 青茶；（糖鍵檸檬鍵）
翡翠檸檬青（M）｜檸檬30cc + 青茶；（糖鍵檸檬鍵）

鮮榨柳橙綠（Ｌ）｜柳橙160cc + 綠茶；（糖鍵柳橙鍵）
鮮榨柳橙綠（M）｜柳橙120cc + 綠茶；（糖鍵柳橙鍵）
鮮榨柳橙青（Ｌ）｜柳橙160cc + 青茶；（糖鍵柳橙鍵）
鮮榨柳橙青（M）｜柳橙120cc + 青茶；（糖鍵柳橙鍵）

鮮百香紅（Ｌ）｜百香40cc + 檸檬10cc + 紅茶；（糖鍵百香鍵）
鮮百香紅（M）｜百香30cc + 檸檬5cc + 紅茶；（糖鍵百香鍵）
鮮百香綠（Ｌ）｜百香40cc + 檸檬10cc + 綠茶；（糖鍵百香鍵）
鮮百香綠（M）｜百香30cc + 檸檬5cc + 綠茶；（糖鍵百香鍵）
鮮百香青（Ｌ）｜百香40cc + 檸檬10cc + 青茶；（糖鍵百香鍵）
鮮百香青（M）｜百香30cc + 檸檬5cc + 青茶；（糖鍵百香鍵）

蜂蜜紅茶（Ｌ）｜蜂蜜50cc + 紅茶；（不額外加糖）
蜂蜜紅茶（M）｜蜂蜜40cc + 紅茶；（不額外加糖）
蜂蜜綠茶（Ｌ）｜蜂蜜50cc + 綠茶；（不額外加糖）
蜂蜜綠茶（M）｜蜂蜜40cc + 綠茶；（不額外加糖）

毛豆奶昔｜毛豆100g + 鮮奶160cc + RO + 冰塊；（糖鍵冰沙鍵）
酪梨鮮奶｜酪梨50g + 鮮奶140cc + 冰塊 + RO；（糖鍵酪梨鍵）
酪梨火龍果鮮奶｜酪梨火龍果 + 鮮奶140cc + 冰塊 + RO；（糖鍵酪梨鍵）

甘蔗檸檬（L）｜甘蔗汁240cc + 檸檬20cc + RO；（糖鍵白玉甘蔗鍵）
甘蔗檸檬（M）｜甘蔗汁200cc + 檸檬15cc + RO；（糖鍵白玉甘蔗鍵）
甘蔗金桔（L）｜甘蔗汁240cc + 金桔20cc + 3顆金桔 + RO；（糖鍵白玉甘蔗鍵）
甘蔗金桔（M）｜甘蔗汁200cc + 金桔15cc + 3顆金桔 + RO；（糖鍵白玉甘蔗鍵）
甘蔗紅茶（L）｜甘蔗汁160cc + 紅茶；（糖鍵白玉甘蔗鍵）
甘蔗綠茶（L）｜甘蔗汁160cc + 綠茶；（糖鍵白玉甘蔗鍵）
甘蔗青茶（L）｜甘蔗汁160cc + 青茶；（糖鍵白玉甘蔗鍵）
甘蔗紅茶（M）｜甘蔗汁120cc + 紅茶；（糖鍵白玉甘蔗鍵）
甘蔗綠茶（M）｜甘蔗汁120cc + 綠茶；（糖鍵白玉甘蔗鍵）
甘蔗青茶（M）｜甘蔗汁120cc + 青茶；（糖鍵白玉甘蔗鍵）

百香QQ（波霸蘆薈愛玉）｜百香30cc + 檸檬5cc + 波霸 + 蘆薈 + 愛玉 + RO；（糖鍵百香鍵）
檸檬愛玉｜檸檬30cc + 愛玉 + RO；（糖鍵檸檬鍵）
百香愛玉｜百香30cc + 檸檬5cc + 愛玉 + RO；（糖鍵百香鍵）

金桔檸檬（L）｜梅汁10cc + 檸檬30cc + 金桔20cc + 百香10cc + 3顆金桔 + RO；（糖鍵檸檬鍵）
金桔檸檬（M）｜梅汁10cc + 檸檬20cc + 金桔10cc + 百香5cc + 3顆金桔 + RO；（糖鍵檸檬鍵）

葡萄柚蜜奇亞籽｜蜂蜜40cc + 葡萄柚120cc + 奇亞籽 + RO；（不額外加糖）
檸檬蘆薈｜檸檬40cc + 蘆薈 + RO；
柳橙蘆薈｜柳橙160cc + 蘆薈 + RO；
橙果粒（蘆薈愛玉）｜柳橙120cc + 蘆薈 + 愛玉 + RO；
柚果粒（蘆薈愛玉）｜葡萄柚120cc + 蘆薈 + 愛玉 + RO；
蜂蜜檸檬奇亞籽｜蜂蜜40cc + 檸檬30cc + 奇亞籽 + RO；

金鑽鳳梨雪沙｜鳳梨140g + RO + 冰塊；
金鑽鳳梨百香｜鳳梨140g + RO + 冰塊 + 百香30cc（加入杯中）；
金鑽鳳梨百香綠／青｜鳳梨140g + 茶100cc + 冰塊 + 百香30cc（加入杯中）；

多多綠（L）｜多多2罐 + 茶；
多多綠（M）｜多多1罐 + 茶；
檸檬多多（L）｜多多2罐 + 檸檬40cc + RO；
檸檬多多（M）｜多多1罐 + 檸檬30cc + RO；
百香果多多（L）｜多多2罐 + 百香40cc + 檸檬10cc + RO；
百香果多多（M）｜多多1罐 + 百香30cc + 檸檬5cc + RO；
葡萄柚多多（L）｜多多2罐 + 葡萄柚160cc + RO；
葡萄柚多多（M）｜多多1罐 + 葡萄柚120cc + RO；

冬瓜檸檬（L）｜檸檬40cc + RO100 + 冬瓜茶；
冬瓜檸檬（M）｜檸檬30cc + RO100 + 冬瓜茶；
冬瓜金桔（L）｜金桔40cc + RO100 + 冬瓜茶；
冬瓜金桔（M）｜金桔30cc + RO100 + 冬瓜茶；

芭樂梅｜芭樂180g + RO + 梅汁10cc + 冰塊；
番茄梅｜番茄150g + RO + 梅汁15cc + 冰塊；
芭樂檸檬｜芭樂180g + RO + 梅汁5cc + 檸檬20cc + 冰塊；

奇異果雪沙｜奇異果150g + RO + 冰塊 + 檸檬5cc；
火龍果雪沙｜火龍果150g + RO + 冰塊；
芒果雪沙｜芒果100g + RO + 冰塊 + 兩匙芒果丁；
芒果奶酪布丁｜RO + 冰塊 + 鮮奶50cc + 一匙芒果丁 + 奶酪布丁；
芒果芝芝奶蓋｜RO + 冰塊 + 一匙芒果丁 + 一匙奶酪布丁 + 奶蓋；

可可歐蕾（L）｜可可2匙 + 鮮奶80cc + RO + 奶蓋；
可可歐蕾（M）｜可可1.5匙 + 鮮奶40cc + RO + 奶蓋；

黑糖鮮奶（L）｜黑糖45cc + 鮮奶300cc + RO；
黑糖鮮奶（M）｜黑糖35cc + 鮮奶220cc + RO；
黑糖鮮奶波霸（L）｜黑糖35cc + 波霸 + 鮮奶220cc + RO；
黑糖鮮奶波霸（M）｜黑糖20cc + 波霸 + 鮮奶180cc + RO；

黑糖奶茶（L）｜黑糖45cc + 錫蘭奶茶；
黑糖奶茶（M）｜黑糖40cc + 錫蘭奶茶；
黑糖波霸奶茶（L）｜黑糖30cc + 波霸 + 錫蘭奶茶；
黑糖波霸奶茶（M）｜黑糖20cc + 波霸 + 錫蘭奶茶；

黑糖芋泥鮮奶（M）｜芋泥100cc + 黑糖20cc + 鮮奶220cc；
芋泥鮮奶（M）｜芋泥100cc + 鮮奶；

紅豆鮮奶（L）｜紅豆 + 鮮奶300cc + RO；
紅豆鮮奶（M）｜紅豆 + 鮮奶200cc + RO；
紅豆波霸鮮奶（L）｜紅豆 + 波霸 + 鮮奶300cc + RO；
紅豆波霸鮮奶（M）｜紅豆 + 波霸 + 鮮奶200cc + RO；
波霸鮮奶（L）｜波霸 + 鮮奶200cc + RO；
波霸鮮奶（M）｜波霸 + 鮮奶200cc + RO；

甘蔗鮮奶（L）｜甘蔗汁300cc + 鮮奶220cc + RO；
甘蔗鮮奶（M）｜甘蔗汁200cc + 鮮奶160cc + RO；
甘蔗鮮奶（M+料）｜甘蔗汁140cc + 鮮奶120cc + RO；

阿華田鮮奶（L）｜阿華田3匙 + 鮮奶160cc + RO；
阿華田鮮奶（M）｜阿華田2匙 + 鮮奶120cc + RO；
阿華田鮮奶（M+料）｜阿華田1匙 + 鮮奶80cc + RO；

錫蘭紅鮮奶（L）｜鮮奶180cc + 紅茶；
錫蘭紅鮮奶（M）｜鮮奶140cc + 紅茶；
錫蘭紅鮮奶（M+料）｜鮮奶120cc + 紅茶；
茉香綠鮮奶（L）｜鮮奶180cc + 綠茶；
茉香綠鮮奶（M）｜鮮奶140cc + 綠茶；
茉香綠鮮奶（M+料）｜鮮奶120cc + 綠茶；
文山青鮮奶（L）｜鮮奶180cc + 青茶；
文山青鮮奶（M）｜鮮奶140cc + 青茶；
文山青鮮奶（M+料）｜鮮奶120cc + 青茶；
鐵觀音鮮奶（L）｜鮮奶180cc + 鐵觀音；
鐵觀音鮮奶（M）｜鮮奶140cc + 鐵觀音；
鐵觀音鮮奶（M+料）｜鮮奶120cc + 鐵觀音；
玄米鮮奶（L）｜鮮奶180cc + 玄米；
玄米鮮奶（M）｜鮮奶140cc + 玄米；
玄米鮮奶（M+料）｜鮮奶120cc + 玄米；

可可鮮奶（L）｜可可2匙 + 鮮奶160cc + RO；
可可鮮奶（M）｜可可1.5匙 + 鮮奶140cc + RO；

芝麻鮮奶茶｜芝麻粉2匙 + 鮮奶140cc + 紅茶；
錫蘭奶茶｜錫蘭奶茶；
茉香奶茶（L）｜綠茶 + 奶精4匙；
茉香奶茶（M）｜綠茶 + 奶精3匙；
茉香奶茶（M+料）｜綠茶 + 奶精2匙；
文山青奶茶（L）｜青茶 + 奶精4匙；
文山青奶茶（M）｜青茶 + 奶精3匙；
文山青奶茶（M+料）｜青茶 + 奶精2匙；
鐵觀音奶茶（L）｜鐵觀音 + 奶精4匙；
鐵觀音奶茶（M）｜鐵觀音 + 奶精3匙；
鐵觀音奶茶（M+料）｜鐵觀音 + 奶精2匙；
玄米奶茶（L）｜玄米 + 奶精4匙；
玄米奶茶（M）｜玄米 + 奶精3匙；
玄米奶茶（M+料）｜玄米 + 奶精2匙；
紅豆波霸奶茶（L）｜紅豆 + 波霸 + 錫蘭奶茶；
紅豆波霸奶茶（M+料）｜紅豆 + 波霸 + 錫蘭奶茶；
可可奶茶（L）｜錫蘭奶茶 + 可可2匙；
可可奶茶（M）｜錫蘭奶茶 + 可可1.5匙；
可可奶茶（M+料）｜錫蘭奶茶 + 可可1匙；

阿華田（L）｜RO + 阿華田3匙 + 奶精3匙；
阿華田（M）｜RO + 阿華田2匙 + 奶精2匙；
阿華田（M+料）｜RO + 阿華田1匙 + 奶精1匙；
奶酪布丁奶茶（L）｜奶酪布丁 + 錫蘭奶茶；
奶酪布丁奶茶（M+料）｜奶酪布丁 + 錫蘭奶茶；
白鬍子奶蓋紅｜紅茶 + 奶蓋；
白鬍子奶蓋綠｜綠茶 + 奶蓋；
白鬍子奶蓋青｜青茶 + 奶蓋；
白鬍子奶蓋玄米｜玄米 + 奶蓋；
白鬍子奶蓋鐵觀音｜鐵觀音 + 奶蓋；
芝麻奶茶（L）｜芝麻粉2匙 + 錫蘭奶茶；
芝麻奶茶（M）｜芝麻粉1.5匙 + 錫蘭奶茶；
杏仁奶茶（L）｜杏仁粉2匙 + 錫蘭奶茶；
杏仁奶茶（M）｜杏仁粉1.5匙 + 錫蘭奶茶；
水蜜桃雪沙｜水蜜桃果粒50g + RO + 冰塊；
水蜜桃紅｜水蜜桃果粒100g + 紅茶；
水蜜桃綠｜水蜜桃果粒100g + 綠茶；
水蜜桃青｜水蜜桃果粒100g + 青茶；
蜜桃檸檬紅｜水蜜桃果粒100g + 檸檬10cc + 紅茶；
蜜桃檸檬綠｜水蜜桃果粒100g + 檸檬10cc + 綠茶；
蜜桃檸檬青｜水蜜桃果粒100g + 檸檬10cc + 青茶；
`;

/* ============== 解析與出題工具 ============== */
const STOPWORDS = /(補|至|去冰|加入|加料|退杯|淋上|鍵|滿|杯|化開|不足|杯中|大杯|中杯|小杯)/;
const ALIAS = {
  'RO水':'RO','熱RO':'RO','冰RO':'RO',
  '芝麻':'芝麻粉',
  '阿華田粉':'阿華田',
  '百香果':'百香','檸檬汁':'檸檬','金桔汁':'金桔','柳橙汁':'柳橙','葡萄柚汁':'葡萄柚',
  '甘蔗':'甘蔗汁', '甘蔗水':'甘蔗汁'
};
const BLOCK = new Set(['糖','加糖','茶']); // 不要出成選項的泛詞

const ING_MASTER = [
  'RO','冰塊','紅茶','綠茶','青茶','鐵觀音','冬瓜茶','錫蘭奶茶','玄米','奶精',
  '蜂蜜','黑糖','阿華田','可可','芝麻粉','杏仁粉','芋泥','紅豆','杏仁凍',
  '梅汁','檸檬','金桔','柳橙','甘蔗汁','葡萄柚','百香','鮮奶','奶蓋','芒果丁',
  '波霸','愛玉','蘆薈','仙草','奶酪布丁','奇亞籽','多多','鳳梨','芒果','奇異果',
  '火龍果','番茄','酪梨','酪梨火龍果','毛豆','水蜜桃果粒','芭樂'
];

function normalizeIngredient(s){
  let ing = (s||'').toString().trim();
  ing = ing.replace(/[+；;、。，（）()]/g,'').replace(/\s+/g,'');
  if(!ing || STOPWORDS.test(ing)) return null;
  if (ALIAS[ing]) ing = ALIAS[ing];
  ing = ing.replace(/^冰塊.*$/,'冰塊');
  ing = ing.replace(/^RO\d+$/,'RO');
  if(BLOCK.has(ing)) return null;
  return ing;
}
function cn2num(txt){
  const map = {'零':0,'一':1,'二':2,'兩':2,'三':3,'四':4,'五':5,'六':6,'七':7,'八':8,'九':9,'十':10};
  if(/^\d+$/.test(txt)) return parseInt(txt,10);
  if(txt==='十') return 10;
  let m=txt.match(/^(十)([一二三四五六七八九])$/); if(m) return 10+map[m[2]];
  m=txt.match(/^([一二三四五六七八九])十([一二三四五六七八九])?$/); if(m) return map[m[1]]*10+(m[2]?map[m[2]]:0);
  m=txt.match(/^([一二三四五六七八九])$/); if(m) return map[m[1]];
  return NaN;
}
function extractFacts(text){
  const facts=[];
  if(!text) return facts;
  // 1) 成分 數量 單位
  let re1=/([\u4e00-\u9fa5A-Za-z（）()\/]+?)\s*([0-9一二兩三四五六七八九十.]+)\s*(cc|g|匙|顆|罐|分)?/g, m;
  while((m=re1.exec(text))!==null){
    let ing=normalizeIngredient(m[1]); if(!ing) continue;
    let nstr=m[2]; let num=/^\d+(\.\d+)?$/.test(nstr)?parseFloat(nstr):cn2num(nstr);
    let unit=m[3]||'';
    if(ing && !isNaN(num)) facts.push({ingredient:ing, amount:num, unit});
  }
  // 2) 數量 單位 成分
  let re2=/([0-9一二兩三四五六七八九十.]+)\s*(cc|g|匙|顆|罐|分)\s*([\u4e00-\u9fa5A-Za-z（）()\/]+?)(?=[+；;、，\s]|$)/g;
  while((m=re2.exec(text))!==null){
    let num=/^\d+(\.\d+)?$/.test(m[1])?parseFloat(m[1]):cn2num(m[1]);
    let unit=m[2]||''; let ing=normalizeIngredient(m[3]); if(!ing) continue;
    if(!isNaN(num)) facts.push({ingredient:ing, amount:num, unit});
  }
  // 3) RO100 → 100cc
  let reRO=/RO\s*?(\d+)/g;
  while((m=reRO.exec(text))!==null){ facts.push({ingredient:'RO', amount:parseInt(m[1],10), unit:'cc'}); }
  // 4) 沒數字但有提到的既知配料
  const presentByName=new Set(facts.map(f=>f.ingredient));
  ING_MASTER.forEach(name=>{
    const norm=normalizeIngredient(name);
    if(norm && text.includes(name) && !presentByName.has(norm)) facts.push({ingredient:norm, amount:null, unit:''});
  });
  // 去重
  const seen={};
  return facts.filter(f=>{
    const key=f.ingredient+'|'+(f.amount??'')+'|'+(f.unit||'');
    if(seen[key]) return false; seen[key]=1; return true;
  });
}

const deck = lines.split(/\n+/).map(l=>l.trim()).filter(Boolean).map(l=>{
  const p=l.split(/\s*[\|｜]\s*/); return {name:p[0], formula:p[1]||""};
});
const GLOBAL_POOL = Array.from(new Set(
  [...ING_MASTER.map(normalizeIngredient),
   ...deck.flatMap(d=>extractFacts(d.formula).map(f=>f.ingredient))]
)).filter(Boolean);

/* ============== 出題：用量 / 多選成分 ============== */
const TOTAL=20, POINT=5;
let paper=[], idx=0, scoreTotal=0, currentQ=null, answered=false;

function pick(a){ return a[Math.floor(Math.random()*a.length)]; }
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; }

function makeAmountQuestion(item){
  const facts=extractFacts(item.formula).filter(f=>f.unit);
  if(!facts.length) return null;
  const f=pick(facts);
  const correctText = (f.unit==='罐' || f.unit==='匙' || f.unit==='顆')
    ? `${stripFloat(f.amount)}${f.unit}` : `${stripFloat(f.amount)}${f.unit}`;

  // 生成「相近」誤差值。若單位為罐/匙/顆，使用 1~4 範圍選項。
  let candidates=[];
  if(f.unit==='罐' || f.unit==='匙' || f.unit==='顆'){
    const universe=[1,2,3,4];
    candidates=universe.filter(n=>n!==Math.round(f.amount)).map(n=>`${n}${f.unit}`);
  }else{
    const pool=[5,10,15,20,30,40,45,50,60,80,100,120,140,160,180,200,220,240,300];
    candidates=pool.filter(v=>v!==f.amount)
                   .sort((a,b)=>Math.abs(a-f.amount)-Math.abs(b-f.amount))
                   .slice(0,3).map(v=>`${v}${f.unit}`);
  }
  const options=shuffle([correctText, ...candidates]).map((t,i)=>({text:t, value:t}));

  const qtext=`「${item.name}」中，<b>${f.ingredient}</b> 用量是多少？`;
  return {type:'amount', name:item.name, q:qtext, options, answer:new Set([correctText]),
          correctCount:1, formula:item.formula};
}
function stripFloat(n){ return (Math.round(n*10)/10).toString().replace(/\.0$/,''); }

function makeMultiIngredientQuestion(item){
  const present = Array.from(new Set(extractFacts(item.formula).map(f=>f.ingredient))).filter(Boolean);
  const presentFiltered = present.filter(x=>!BLOCK.has(x) && x!=='茶'); // 確保不出現「茶」泛詞
  if(presentFiltered.length<2) return null;

  // 讓選項 5 個：正確若少於 5，就補充錯誤干擾
  const absent = GLOBAL_POOL.filter(x=>!presentFiltered.includes(x));
  const correct = presentFiltered.slice(0, Math.min(3, presentFiltered.length)); // 控制 2~3 個正確較佳
  let wrongs = [];
  for(const n of shuffle(absent)){
    if(wrongs.length+correct.length>=5) break;
    wrongs.push(n);
  }
  const all = shuffle([...correct, ...wrongs]).slice(0,5);
  const options = all.map(t=>({text:t, value:t}));

  const qtext = `請勾選「${item.name}」的所有正確成分（多選）。`;
  return {type:'multi', name:item.name, q:qtext, options, answer:new Set(correct),
          correctCount:correct.length, formula:item.formula};
}

function buildOne(mode){
  let guard=0, q=null;
  while(!q && guard<300){
    guard++;
    const item=pick(deck);
    const m= (mode==='mixed') ? (Math.random()<0.5?'multi':'amount') : (mode==='ingredientAll'?'multi':mode);
    q = (m==='amount')? makeAmountQuestion(item) : makeMultiIngredientQuestion(item);
  }
  return q;
}
function genPaper(){
  paper=[]; scoreTotal=0; idx=0;
  const mode=document.getElementById('mode').value;
  const seen=new Set();
  while(paper.length<TOTAL){
    const q=buildOne(mode); if(!q) continue;
    const key=q.name+'|'+q.q;
    if(seen.has(key)) continue;
    seen.add(key); paper.push(q);
  }
}

/* ============== UI 綁定 ============== */
const $ = sel => document.querySelector(sel);
const qtitle=$("#qtitle"), optionsBox=$("#options"), explainBox=$("#explain"),
      scoreline=$("#scoreline"), formulaEl=$("#formula"),
      metaTop=$("#metaTop"), card=$("#card"), rules=$("#rules"),
      submitBtn=$("#submitBtn"), nextBtn=$("#nextBtn"),
      startBtn=$("#startBtn"), summary=$("#summary");

startBtn.onclick = startExam;
submitBtn.onclick = submitAnswer;
nextBtn.onclick = nextQuestion;

function startExam(){
  genPaper();
  rules.style.display='none';      // 開始測驗後規則隱藏
  card.style.display='block';
  summary.style.display='none';
  idx=0; scoreTotal=0;
  renderCurrent();
}
function renderCurrent(){
  answered=false;
  const q=paper[idx]; currentQ=q;
  qtitle.innerHTML = `第 ${idx+1} / ${TOTAL} 題｜${q.q}`;
  optionsBox.innerHTML='';

  if(q.type==='multi'){
    q.options.forEach((opt,i)=>{
      const div=document.createElement('div'); div.className='option';
      div.innerHTML=`<input type="checkbox" id="o${i}"><label for="o${i}"><b>${String.fromCharCode(65+i)})</b> ${opt.text}</label>`;
      optionsBox.appendChild(div);
    });
  }else{ // amount 單選
    q.options.forEach((opt,i)=>{
      const div=document.createElement('div'); div.className='option';
      div.innerHTML=`<input type="radio" name="single" id="o${i}" value="${opt.value}">
                     <label for="o${i}"><b>${String.fromCharCode(65+i)})</b> ${opt.text}</label>`;
      optionsBox.appendChild(div);
    });
  }
  explainBox.style.display='none';
  scoreline.textContent=''; formulaEl.textContent='';
  submitBtn.disabled=false; nextBtn.disabled=true;
  updateMeta();
}
function updateMeta(){
  metaTop.textContent = `進度：${idx}/${TOTAL}｜得分：${Math.round(scoreTotal*10)/10}/100`;
}
function getSelections(){
  const arr=[...optionsBox.querySelectorAll('input')];
  if(currentQ.type==='multi'){
    return new Set(arr.filter(x=>x.checked).map(x=>{
      const text = x.parentElement.querySelector('label').textContent.replace(/^[A-E]\)\s*/,'').trim();
      return text;
    }));
  }else{
    const r=arr.find(x=>x.checked); return r? new Set([r.value]): new Set();
  }
}
function submitAnswer(){
  if(answered) return;
  const sel = getSelections();
  const q=currentQ;

  if(q.type==='multi' && sel.size===0){ alert('請至少勾選一個選項'); return; }
  if(q.type==='amount' && sel.size===0){ alert('請先選擇答案'); return; }

  // 標記選項
  const rows=[...optionsBox.querySelectorAll('.option')];
  const labelText = rows.map(r => r.querySelector('label').textContent.replace(/^[A-E]\)\s*/,'').trim());

  rows.forEach((row,i)=>{
    const text=labelText[i];
    if(q.answer.has(text)) row.classList.add('correct'); // 正確的全變綠底
    if(sel.has(text) && !q.answer.has(text)) row.classList.add('wrong'); // 勾到錯的：紅底
  });
  // 沒選到但正確 → 紅框
  labelText.forEach((t,i)=>{ if(q.answer.has(t) && !sel.has(t)) rows[i].classList.add('missed'); });

  // 計分
  let earned=0;
  if(q.type==='multi'){
    const correctNum=q.correctCount;
    const per=POINT/correctNum;
    let rightChosen=0, wrongChosen=0;
    sel.forEach(v=>{ if(q.answer.has(v)) rightChosen++; else wrongChosen++; });
    earned = Math.max(0, rightChosen*per - wrongChosen*per);
  }else{
    earned = sel.size && q.answer.has([...sel][0]) ? POINT : 0;
  }
  scoreTotal += earned;

  // 顯示「本題得分」與「完整配方」分兩行
  explainBox.style.display='block';
  scoreline.textContent = `本題得分：${Math.round(earned*10)/10} / ${POINT}。`;
  formulaEl.textContent = `完整配方：${q.formula.replace(/；.*$/,'')}`;

  submitBtn.disabled=true; nextBtn.disabled=false; answered=true;
  updateMeta();
}
function nextQuestion(){
  if(!answered) return;
  idx++;
  if(idx>=TOTAL){ showSummary(); return; }
  renderCurrent();
}
function showSummary(){
  card.style.display='none';
  rules.style.display='block';     // 測驗結束規則回來
  summary.style.display='block';
  const rounded = (Math.round(scoreTotal*10)/10).toFixed(1).replace(/\.0$/,'');
  summary.innerHTML = `<b>本次成績：${rounded} 分（滿分 100）</b>
                       <div style="margin-top:8px">題型：${document.getElementById('mode').value}</div>
                       <div style="margin-top:10px"><button class="btn btn-primary" onclick="startExam()">再試一次</button></div>`;
  metaTop.textContent = `進度：${TOTAL}/20｜得分：${rounded}/100`;
}
</script>
</body>
</html>
