<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>飲料配方選擇題</title>
<style>
  :root{--card:#ffffff;--muted:#6b7280;--radius:14px;--brand:#10b981;--danger:#ef4444}
  body{margin:0;font-family:system-ui,-apple-system,"PingFang TC","Noto Sans TC",Segoe UI,Roboto,sans-serif;color:#111;background:#f7f7f7}

  /* 背景輪播 */
  #bg,#bg .bg-layer,#bg-overlay{position:fixed;inset:0}
  #bg{z-index:-3}
  #bg .bg-layer{background:center/cover no-repeat;opacity:0;transition:opacity 1.2s ease-in-out;will-change:opacity,background-image}
  #bg .bg-layer.show{opacity:1}
  #bg-overlay{z-index:-2;pointer-events:none;background:linear-gradient(to bottom,rgba(255,255,255,.90) 0%,rgba(255,255,255,.86) 22%,rgba(255,255,255,.82) 55%,rgba(255,255,255,.88) 100%);backdrop-filter:blur(1px)}

  /* 左上角 logo */
  #cornerLogo{position:fixed;left:18px;top:12px;width:74px;height:auto;user-select:none;pointer-events:none;z-index:5}

  .container{max-width:980px;margin:24px auto;padding:0 16px}

  .toolbar{background:var(--card);border:1px solid #e5e7eb;border-radius:var(--radius);box-shadow:0 1px 0 rgba(0,0,0,.02);padding:16px 18px}
  .toolbar h1{margin:2px 0 10px;text-align:center;font-size:22px;font-weight:800;letter-spacing:2px}
  .tools{display:flex;align-items:center;gap:10px}
  .tools .spacer{flex:1}
  #metaTop{color:var(--muted);font-size:14px}

  .card{background:var(--card);border:1px solid #e5e7eb;border-radius:var(--radius);padding:18px;margin-top:16px;box-shadow:0 1px 0 rgba(0,0,0,.02)}
  #ruleCard p{margin:14px 0 20px;line-height:1.9}
  #ruleCard .badge{display:inline-block;border-radius:10px;padding:2px 8px;margin-right:6px}

  select,button{font-size:16px;padding:10px 14px;border-radius:10px;border:1px solid #d1d5db;background:#fff;cursor:pointer}
  .btn-primary{background:var(--brand);border-color:#0f9e72;color:#fff}
  .btn-ghost{background:#fff}
  .btn-primary:disabled{opacity:.45;cursor:not-allowed}

  #qtitle{font-weight:800;font-size:20px;margin-bottom:8px}
  .option{display:flex;align-items:center;gap:10px;border:1px solid #e5e7eb;border-radius:12px;padding:12px 14px;margin:8px 0;background:#fff}
  .option input{transform:scale(1.15)}
  .option label{flex:1;cursor:pointer;color:#111}
  .option.ok{background:#eafaf0;border-color:#22c55e}
  .option.miss{background:#eafaf0;border-color:var(--danger);box-shadow:0 0 0 2px rgba(239,68,68,.35) inset}
  .option.wrong{border-color:var(--danger);box-shadow:0 0 0 2px rgba(239,68,68,.35) inset}

  #explain{color:#374151;margin-top:8px}
  .control-row{display:flex;gap:10px;align-items:center;margin-top:10px}
  .control-row .spacer{flex:1}
  .scorebig{font-size:22px;font-weight:800}
</style>
</head>
<body>
  <div id="bg">
    <div class="bg-layer" id="bgA"></div>
    <div class="bg-layer" id="bgB"></div>
  </div>
  <div id="bg-overlay"></div>
  <img id="cornerLogo" src="logo.png" alt="logo">

  <div class="container">
    <div class="toolbar">
      <h1>飲料配方選擇題</h1>
      <div class="tools">
        <div style="display:flex;align-items:center;gap:10px">
          <label>題型：</label>
          <select id="mode">
            <option value="mixed">混合（多選成分＋用量）</option>
            <option value="ingredient">配料題（多選）</option>
            <option value="amount">用量題（單選）</option>
          </select>
          <button class="btn-primary" id="startBtn">開始測驗</button>
        </div>
        <div class="spacer"></div>
        <span id="metaTop">進度：0/20｜得分：0/100</span>
      </div>
    </div>

    <div class="card" id="ruleCard">
      <p><b>規則：</b>20 題，每題 5 分。</p>
      <p><b>多選題評分：</b>每題滿分 5 分，正確選一項得 <b>5 / 正確數</b> 分；每多選一個錯誤扣同額（最低 0 分）。</p>
      <p>
        <b>標示：</b>
        <span class="badge" style="background:#eafaf0;border:1px solid #22c55e;">綠底＝正確成分</span>
        <span class="badge" style="background:#eafaf0;border:1px solid #ef4444;">紅框＝勾錯或漏選</span>
      </p>
    </div>

    <div class="card" id="qaCard" style="display:none">
      <div id="qtitle"></div>
      <div id="optBox"></div>
      <div id="explain"></div>
      <div class="control-row">
        <button id="submitBtn" class="btn-primary">送出答案</button>
        <button id="nextBtn" class="btn-ghost" disabled>下一題</button>
        <div class="spacer"></div>
      </div>
    </div>

    <div class="card" id="resultCard" style="display:none">
      <div id="resultText" class="scorebig"></div>
      <div style="margin-top:10px"><button id="retryBtn" class="btn-primary">再試一次</button></div>
    </div>
  </div>

<script>
/* ==== 背景輪播 ==== */
const BG = ["bg1.jpg","bg2.jpg","bg3.jpg","bg4.jpg","bg5.jpg","bg6.jpg"];
const DURATION_MS = 10000;
const layerA = document.getElementById('bgA');
const layerB = document.getElementById('bgB');
let curBg=0,useA=true;
function showSlide(i,first=false){
  const t=useA?layerA:layerB, o=useA?layerB:layerA;
  t.style.backgroundImage = `url("${BG[i]}")`;
  if(first){ t.classList.add('show'); } else { requestAnimationFrame(()=>{ t.classList.add('show'); o.classList.remove('show'); }); }
  useA=!useA;
}
showSlide(curBg,true);
setInterval(()=>{ curBg=(curBg+1)%BG.length; showSlide(curBg); }, DURATION_MS);/* ========== 題庫（最新） ========== */
const lines = `
錫蘭紅茶｜紅茶；（糖鍵紅茶鍵）
茉香綠茶｜綠茶；（糖鍵原茶鍵）
文山青茶｜青茶；（糖鍵原茶鍵）
玄米煎茶｜玄米；（糖鍵原茶鍵）
碳焙鐵觀音｜鐵觀音；（糖鍵原茶鍵）
冬瓜茶｜冬瓜茶；（不額外加糖）
柳橙百香綠（Ｌ）｜柳橙100cc + 百香20cc + 綠茶；（糖鍵柳橙鍵）
柳橙百香綠（Ｍ）｜柳橙80cc + 百香15cc + 綠茶；（糖鍵柳橙鍵）
奇異果綠茶｜奇異果150g + 檸檬5cc + 綠茶；（糖鍵奇異果綠茶鍵）
鮮榨葡萄柚綠（Ｌ）｜葡萄柚160cc + 綠茶；（糖鍵葡萄柚鍵）
鮮榨葡萄柚綠（M）｜葡萄柚120cc + 綠茶；（糖鍵葡萄柚鍵）
鮮榨葡萄柚青（Ｌ）｜葡萄柚160cc + 青茶；（糖鍵葡萄柚鍵）
鮮榨葡萄柚青（M）｜葡萄柚160cc + 青茶；（糖鍵葡萄柚鍵）
百香奇亞籽｜奇亞籽 + 百香30cc + 檸檬5cc + 紅茶100cc + RO；（糖鍵百香鍵）
檸檬奇亞籽｜奇亞籽 + 檸檬30cc + 紅茶100cc + RO；（糖鍵檸檬鍵）
柳橙奇亞籽｜奇亞籽 + 柳橙120cc + 紅茶100cc + RO；（糖鍵柳橙鍵）
翡翠檸檬紅（Ｌ）｜檸檬40cc + 紅茶；（糖鍵檸檬鍵）
翡翠檸檬紅（M）｜檸檬30cc + 紅茶；（糖鍵檸檬鍵）
翡翠檸檬綠（Ｌ）｜檸檬40cc + 綠茶；（糖鍵檸檬鍵）
翡翠檸檬綠（M）｜檸檬30cc + 綠茶；（糖鍵檸檬鍵）
翡翠檸檬青（Ｌ）｜檸檬40cc + 青茶；（糖鍵檸檬鍵）
翡翠檸檬青（M）｜檸檬30cc + 青茶；（糖鍵檸檬鍵）
鮮榨柳橙綠（Ｌ）｜柳橙160cc + 綠茶；（糖鍵柳橙鍵）
鮮榨柳橙綠（M）｜柳橙120cc + 綠茶；（糖鍵柳橙鍵）
鮮榨柳橙青（Ｌ）｜柳橙160cc + 青茶；（糖鍵柳橙鍵）
鮮榨柳橙青（M）｜柳橙120cc + 青茶；（糖鍵柳橙鍵）
鮮百香紅（Ｌ）｜百香40cc + 檸檬10cc + 紅茶；（糖鍵百香鍵）
鮮百香紅（M）｜百香30cc + 檸檬5cc + 紅茶；（糖鍵百香鍵）
鮮百香綠（Ｌ）｜百香40cc + 檸檬10cc + 綠茶；（糖鍵百香鍵）
鮮百香綠（M）｜百香30cc + 檸檬5cc + 綠茶；（糖鍵百香鍵）
鮮百香青（Ｌ）｜百香40cc + 檸檬10cc + 青茶；（糖鍵百香鍵）
鮮百香青（M）｜百香30cc + 檸檬5cc + 青茶；（糖鍵百香鍵）
蜂蜜紅茶（Ｌ）｜蜂蜜50cc + 紅茶；（不額外加糖）
蜂蜜紅茶（M）｜蜂蜜40cc + 紅茶；（不額外加糖）
蜂蜜綠茶（Ｌ）｜蜂蜜50cc + 綠茶；（不額外加糖）
蜂蜜綠茶（M）｜蜂蜜40cc + 綠茶；（不額外加糖）
毛豆奶昔｜毛豆100g + 鮮奶160cc + RO + 冰塊；（糖鍵冰沙鍵） 
酪梨鮮奶｜酪梨50g + 鮮奶140cc + 冰塊 + RO；（糖鍵酪梨鍵）
酪梨火龍果鮮奶｜酪梨火龍果 + 鮮奶140cc + 冰塊 + RO；（糖鍵酪梨鍵） 
甘蔗檸檬（L）｜甘蔗240cc + 檸檬20cc + RO；（糖鍵白玉甘蔗鍵）
甘蔗檸檬（M）｜甘蔗200cc + 檸檬15cc + RO；（糖鍵白玉甘蔗鍵）
甘蔗金桔（L）｜甘蔗240cc + 金桔20cc + 3顆金桔 + RO；（糖鍵白玉甘蔗鍵）
甘蔗金桔（M）｜甘蔗200cc + 金桔15cc + 3顆金桔 + RO；（糖鍵白玉甘蔗鍵）
甘蔗紅茶（L）｜甘蔗160cc + 紅茶；（糖鍵白玉甘蔗鍵）
甘蔗綠茶（L）｜甘蔗160cc + 綠茶；（糖鍵白玉甘蔗鍵）
甘蔗青茶（L）｜甘蔗160cc + 青茶；（糖鍵白玉甘蔗鍵）
甘蔗紅茶（M）｜甘蔗120cc  + 紅茶 ；（糖鍵白玉甘蔗鍵）
甘蔗綠茶（M）｜甘蔗120cc  + 綠茶 ；（糖鍵白玉甘蔗鍵）
甘蔗青茶（M）｜甘蔗120cc  + 青茶 ；（糖鍵白玉甘蔗鍵）
百香QQ（波霸蘆薈愛玉）｜百香30cc + 檸檬5cc + 波霸 + 蘆薈 + 愛玉 + RO；（糖鍵百香鍵）
檸檬愛玉｜檸檬30cc + 愛玉 + RO；（糖鍵檸檬鍵） 
百香愛玉｜百香30cc + 檸檬5cc + 愛玉 + RO；（糖鍵百香鍵） 
金桔檸檬（L）｜梅汁10cc + 檸檬30cc + 金桔20cc + 百香10cc + 3顆金桔 + RO；（糖鍵檸檬鍵） 
金桔檸檬（M）｜梅汁10cc + 檸檬20cc + 金桔10cc + 百香5cc + 3顆金桔 + RO；（糖鍵檸檬鍵） 
葡萄柚蜜奇亞籽｜蜂蜜40cc + 葡萄柚120cc + 奇亞籽 + RO；（不額外加糖） 
檸檬蘆薈｜檸檬40cc + 蘆薈 + RO；（糖鍵檸檬鍵） 
柳橙蘆薈｜柳橙160cc + 蘆薈 + RO；（糖鍵柳橙鍵） 
橙果粒（蘆薈愛玉）｜柳橙120cc + 蘆薈 + 愛玉 + RO；（糖鍵柳橙鍵） 
柚果粒（蘆薈愛玉）｜葡萄柚120cc + 蘆薈 + 愛玉 + RO；（糖鍵葡萄柚鍵）  
蜂蜜檸檬奇亞籽｜蜂蜜40cc + 檸檬30cc + 奇亞籽 + RO；（不額外加糖）  
金鑽鳳梨雪沙｜鳳梨140g + RO + 冰塊；（糖鍵鳳梨鍵） 
金鑽鳳梨百香｜鳳梨140g + RO + 冰塊 + 百香30cc （加入杯中）；（糖鍵鳳梨鍵） 
金鑽鳳梨百香綠／青｜鳳梨140g + 茶100cc + 冰塊 + 百香30cc （加入杯中）；（糖鍵鳳梨鍵） 
多多綠（L）｜多多2罐 + 茶；（糖鍵多多鍵） 
多多綠（M）｜多多1罐 + 茶；（糖鍵多多鍵）
檸檬多多（L）｜多多2罐 + 檸檬40cc + RO；（糖鍵多多鍵）
檸檬多多（M）｜多多1罐 + 檸檬30cc + RO；（糖鍵多多鍵） 
百香果多多（L）｜多多2罐 + 百香40cc + 檸檬10cc + RO；（糖鍵多多鍵）
百香果多多（M）｜多多1罐 + 百香30cc + 檸檬5cc + RO；（糖鍵多多鍵）
葡萄柚多多（L）｜多多2罐 + 葡萄柚160cc + RO；（糖鍵多多鍵）
葡萄柚多多（M）｜多多1罐 + 葡萄柚120cc + RO；（糖鍵多多鍵）
冬瓜檸檬（L）｜檸檬40cc + RO100 + 冬瓜茶；（不額外加糖） 
冬瓜檸檬（M）｜檸檬30cc +  RO100 + 冬瓜茶；（不額外加糖） 
冬瓜金桔（L）｜金桔40cc + RO100 + 冬瓜茶；（不額外加糖、3顆金桔） 
冬瓜金桔（M）｜金桔30cc  + RO100 + 冬瓜茶；（不額外加糖、3顆金桔） 
芭樂梅｜芭樂180g + RO+ 梅汁10cc + 冰塊；（糖鍵冰沙鍵）
番茄梅｜番茄150g + RO+ 梅汁15cc + 冰塊；（糖鍵冰沙鍵）
芭樂檸檬｜芭樂180g + RO + 梅汁5cc + 檸檬20cc + 冰塊；（糖鍵冰沙鍵）
奇異果雪沙｜奇異果150g + RO  + 冰塊 + 檸檬5cc；（糖鍵冰沙鍵） 
火龍果雪沙｜火龍果150g + RO + 冰塊；（糖鍵冰沙鍵）
芒果雪沙｜芒果100g + RO + 冰塊 + 兩匙芒果丁；（糖鍵冰沙鍵） 
芒果奶酪布丁｜RO + 冰塊 + 鮮奶50cc  + 一匙芒果丁 + 奶酪布丁；（糖鍵冰沙鍵） 
芒果芝芝奶蓋｜RO + 冰塊+ 一匙芒果丁 + 一匙奶酪布丁+ 奶蓋；（糖鍵冰沙鍵） 
可可歐蕾（L）｜可可2匙化開 + 鮮奶80cc + RO + 奶蓋；（糖鍵奶香鍵） 
可可歐蕾（M）｜可可1.5匙化開 + 鮮奶40cc + RO + 奶蓋；（糖鍵奶香鍵） 
黑糖鮮奶（L）｜黑糖45cc + 鮮奶300cc + RO；（不額外加糖）
黑糖鮮奶（M）｜黑糖35cc + 鮮奶220cc + RO；（不額外加糖） 
黑糖鮮奶波霸（L）｜黑糖35cc + 波霸 + 鮮奶220cc + RO；（不額外加糖） 
黑糖鮮奶波霸（M）｜黑糖20cc + 波霸 + 鮮奶180cc + RO；（不額外加糖） 
黑糖奶茶（L）｜黑糖45cc + 錫蘭奶茶；（不額外加糖） 
黑糖奶茶（M）｜黑糖40cc + 錫蘭奶茶；（不額外加糖） 
黑糖波霸奶茶（L）｜黑糖30cc  + 波霸 + 錫蘭奶茶；（不額外加糖） 
黑糖波霸奶茶（M）｜黑糖20cc  + 波霸  + 錫蘭奶茶；（不額外加糖） 
黑糖芋泥鮮奶（M）｜芋泥100cc + 黑糖20cc + 鮮奶220cc；（不額外加糖） 
芋泥鮮奶（M）｜芋泥100cc + 鮮奶；（不額外加糖） 
紅豆鮮奶（L）｜兩匙紅豆 + 鮮奶300cc + RO；（不額外加糖） 
紅豆鮮奶（M）｜兩匙紅豆 +  鮮奶200cc + RO；（不額外加糖） 
紅豆波霸鮮奶（L）｜兩匙紅豆 +  波霸 + 鮮奶300cc + RO；（不額外加糖） 
紅豆波霸鮮奶（M）｜兩匙紅豆 +  波霸 + 鮮奶200cc + RO；（不額外加糖）
波霸鮮奶（L）｜波霸 + 鮮奶200cc + RO；（不額外加糖） 
波霸鮮奶（M）｜波霸 +鮮奶200cc + RO；（不額外加糖）
甘蔗鮮奶（L）｜甘蔗300cc + 鮮奶220cc + RO；（不加糖）
甘蔗鮮奶（M）｜甘蔗200cc + 鮮奶160cc + RO；（不額外加糖）
甘蔗鮮奶（M+料）｜甘蔗140cc + 鮮奶120cc + RO；（不額外加糖）
阿華田鮮奶（L）｜阿華田3匙 + 鮮奶160cc + RO；（糖鍵奶香鍵）
阿華田鮮奶（M）｜阿華田2匙 + 鮮奶120cc + RO；（糖鍵奶香鍵）
阿華田鮮奶（M+料）｜阿華田1匙 + 鮮奶80cc + RO；（糖鍵奶香鍵）
錫蘭紅鮮奶（L）｜鮮奶180cc + 紅茶；（糖鍵奶香鍵）
錫蘭紅鮮奶（M）｜鮮奶140cc  + 紅茶；（糖鍵奶香鍵）
錫蘭紅鮮奶（M+料）｜鮮奶120cc + 紅茶；（糖鍵奶香鍵）
茉香綠鮮奶（L）｜鮮奶180cc + 綠茶；（糖鍵奶香鍵）
茉香綠鮮奶（M）｜鮮奶140cc  + 綠茶；（糖鍵奶香鍵）
茉香綠鮮奶（M+料）｜鮮奶120cc + 綠茶；（糖鍵奶香鍵）
文山青鮮奶（L）｜鮮奶180cc + 青茶；（糖鍵奶香鍵）
文山青鮮奶（M）｜鮮奶140cc  + 青茶；（糖鍵奶香鍵）
文山青鮮奶（M+料）｜鮮奶120cc + 青茶；（糖鍵奶香鍵）
鐵觀音鮮奶（L）｜鮮奶180cc + 鐵觀音；（糖鍵奶香鍵）
鐵觀音鮮奶（M）｜鮮奶140cc  + 鐵觀音；（糖鍵奶香鍵）
鐵觀音鮮奶（M+料）｜鮮奶120cc + 鐵觀音；（糖鍵奶香鍵）
玄米鮮奶（L）｜鮮奶180cc + 玄米；（糖鍵奶香鍵）
玄米鮮奶（M）｜鮮奶140cc  + 玄米；（糖鍵奶香鍵）
玄米鮮奶（M+料）｜鮮奶120cc + 玄米；（糖鍵奶香鍵）
冬瓜鮮奶（L）｜鮮奶160cc + 冬瓜茶；（不額外加糖）
冬瓜鮮奶（M）｜鮮奶120cc + 冬瓜茶；（不額外加糖）
可可鮮奶（L）｜可可2匙 + 鮮奶160cc + RO；（糖鍵奶香鍵）
可可鮮奶（M）｜可可1.5匙 + 鮮奶140cc + RO；（糖鍵奶香鍵）
芝麻鮮奶茶｜芝麻2匙 + 鮮奶140cc + 紅茶；（糖鍵奶香鍵）
錫蘭奶茶｜錫蘭奶茶；（糖鍵奶香鍵）
茉香奶茶（L）｜綠茶 + 奶精4匙；（糖鍵奶香鍵）
茉香奶茶（M）｜綠茶 + 奶精3匙；（糖鍵奶香鍵）
茉香奶茶（M+料）｜綠茶 + 奶精2匙；（糖鍵奶香鍵）
文山青奶茶（L）｜青茶 + 奶精4匙；（糖鍵奶香鍵）
文山青奶茶（M）｜青茶 + 奶精3匙；（糖鍵奶香鍵）
文山青奶茶（M+料）｜青茶 + 奶精2匙；（糖鍵奶香鍵）
鐵觀音奶茶（L）｜鐵觀音 + 奶精4匙；（糖鍵奶香鍵）
鐵觀音奶茶（M）｜鐵觀音 + 奶精3匙；（糖鍵奶香鍵）
鐵觀音奶茶（M+料）｜鐵觀音 + 奶精2匙；（糖鍵奶香鍵）
玄米奶茶（L）｜玄米 + 奶精4匙；（糖鍵奶香鍵）
玄米奶茶（M）｜玄米 + 奶精3匙；（糖鍵奶香鍵）
玄米奶茶（M+料）｜玄米 + 奶精2匙；（糖鍵奶香鍵）
紅豆波霸奶茶（L）｜紅豆 + 波霸 + 錫蘭奶茶；（糖鍵奶香鍵）
紅豆波霸奶茶（M+料）｜紅豆 + 波霸 + 錫蘭奶茶；（糖鍵奶香鍵）
可可奶茶（L）｜錫蘭奶茶 + 可可2匙；（糖鍵奶香鍵）
可可奶茶（M）｜錫蘭奶茶 + 可可1.5匙；（糖鍵奶香鍵）
可可奶茶（M+料）｜錫蘭奶茶 + 可可1匙；（糖鍵奶香鍵）
阿華田（L）｜RO + 阿華田3匙 + 奶精3匙；（糖鍵奶香鍵）
阿華田（M）｜RO + 阿華田2匙 + 奶精2匙；（糖鍵奶香鍵）
阿華田（M+料）｜RO + 阿華田1匙 + 奶精1匙；（糖鍵奶香鍵）
奶酪布丁奶茶（L）｜奶酪布丁 + 錫蘭奶茶；（糖鍵奶香鍵）
奶酪布丁奶茶（M+料）｜奶酪布丁 + 錫蘭奶茶；（糖鍵奶香鍵）
白鬍子奶蓋紅｜紅茶 + 奶蓋；（糖鍵紅茶鍵）
白鬍子奶蓋綠｜綠茶 + 奶蓋；（糖鍵原茶鍵）
白鬍子奶蓋青｜青茶 + 奶蓋；（糖鍵原茶鍵）
白鬍子奶蓋玄米｜玄米 + 奶蓋；（糖鍵原茶鍵）
白鬍子奶蓋鐵觀音｜鐵觀音 + 奶蓋；（糖鍵原茶鍵）
芝麻奶茶（L）｜芝麻粉2匙 + 錫蘭奶茶；（糖鍵奶香鍵）
芝麻奶茶（M）｜芝麻粉1.5匙 + 錫蘭奶茶；（糖鍵奶香鍵）
杏仁奶茶（L）｜杏仁粉2匙 + 錫蘭奶茶；（糖鍵奶香鍵）
杏仁奶茶（M）｜杏仁粉1.5匙 + 錫蘭奶茶；（糖鍵奶香鍵）
水蜜桃雪沙｜水蜜桃果粒50g + RO + 冰塊；（糖鍵冰沙鍵）
水蜜桃紅｜水蜜桃果粒100g + 紅茶；（糖鍵柳橙鍵）
水蜜桃綠｜水蜜桃果粒100g + 綠茶；（糖鍵柳橙鍵）
水蜜桃青｜水蜜桃果粒100g + 青茶；（糖鍵柳橙鍵）
蜜桃檸檬紅｜水蜜桃果粒100g + 檸檬10cc + 紅茶；（糖鍵柳橙鍵）
蜜桃檸檬綠｜水蜜桃果粒100g + 檸檬10cc + 綠茶；（糖鍵柳橙鍵）
蜜桃檸檬青｜水蜜桃果粒100g + 檸檬10cc + 青茶；（糖鍵柳橙鍵）
`;

/* ========== 常量 / 規則 ========== */
const TOTAL=20, POINT=5;
const BANNED=new Set(["糖","加糖","茶"]);
const ALIASES={"芝麻":"芝麻粉","百香果":"百香","金桔汁":"金桔","柳橙汁":"柳橙","葡萄柚汁":"葡萄柚","檸檬汁":"檸檬","甘蔗":"甘蔗汁"};
const STOPWORDS_RE=/(糖鍵|補|至|去冰|加入|杯中|不足|化開|大杯鍵|中杯|鍵|滿|尖杯|不額外加糖|不加糖)/;

function cn2num(txt){const m={'零':0,'一':1,'二':2,'兩':2,'三':3,'四':4,'五':5,'六':6,'七':7,'八':8,'九':9,'十':10};if(/^\d+(\.\d+)?$/.test(txt))return parseFloat(txt);if(txt==='十')return 10;let r=txt.match(/^(十)([一二三四五六七八九])$/);if(r)return 10+m[r[2]];r=txt.match(/^([一二三四五六七八九])十([一二三四五六七八九])?$/);if(r)return m[r[1]]*10+(r[2]?m[r[2]]:0);r=txt.match(/^([一二三四五六七八九])$/);if(r)return m[r[1]];return NaN;}
function normIng(s){let x=(s||'').toString().trim();x=x.replace(/[+；;、。，（）()]/g,'').replace(/\s+/g,'');if(!x||STOPWORDS_RE.test(x))return null;x=ALIASES[x]||x;if(/^冰塊/.test(x))x='冰塊';if(/^RO\d+$/i.test(x))x='RO';return x;}
function extractFacts(text){const facts=[];if(!text)return facts;let re1=/([\u4e00-\u9fa5A-Za-z（）()\/]+?)\s*([0-9]+(?:\.[0-9]+)?|[一二兩三四五六七八九十]+)\s*(cc|g|匙|顆|罐)?/g;let m;while((m=re1.exec(text))!==null){let ing=normIng(m[1]);if(!ing)continue;let numStr=m[2];let num=/^\d/.test(numStr)?parseFloat(numStr):cn2num(numStr);let unit=m[3]||'';if(ing&&!isNaN(num))facts.push({ingredient:ing,amount:num,unit});}
let re2=/([0-9]+(?:\.[0-9]+)?|[一二兩三四五六七八九十]+)\s*(cc|g|匙|顆|罐)\s*([\u4e00-\u9fa5A-Za-z（）()\/]+?)(?=[+；;、，\s]|$)/g;
while((m=re2.exec(text))!==null){let num=/^\d/.test(m[1])?parseFloat(m[1]):cn2num(m[1]);let unit=m[2];let ing=normIng(m[3]);if(!ing)continue;if(!isNaN(num))facts.push({ingredient:ing,amount:num,unit});}
let reRO=/RO\s*?(\d+)/gi;while((m=reRO.exec(text))!==null){facts.push({ingredient:'RO',amount:parseFloat(m[1]),unit:'cc'});}
const list=["紅茶","綠茶","青茶","鐵觀音","玄米","錫蘭奶茶","冬瓜茶","奶精","鮮奶","奶蓋","波霸","愛玉","蘆薈","仙草","阿華田","可可","芝麻粉","杏仁粉","紅豆","芋泥","奇亞籽","多多","梅汁","檸檬","金桔","柳橙","甘蔗汁","葡萄柚","百香","芒果丁","水蜜桃果粒","鳳梨","芒果","奇異果","火龍果","番茄","毛豆","RO","冰塊"];
list.forEach(k=>{const raw=k.replace(/粉$/,'');if(text.includes(raw)&&!facts.some(f=>f.ingredient===k))facts.push({ingredient:k,amount:null,unit:''});});
const seen=new Set(),out=[];for(const f of facts){const key=`${f.ingredient}|${f.amount??''}|${f.unit||''}`;if(!seen.has(key)){seen.add(key);out.push(f);}}return out;}

const deck = lines.split(/\n+/).map(l=>l.trim()).filter(Boolean).map(l=>{const p=l.split(/\s*[\|｜]\s*/);return {name:p[0],formula:p[1]||""};});
const GLOBAL_INGS = Array.from(new Set(deck.flatMap(d=>extractFacts(d.formula).map(f=>f.ingredient)))).filter(x=>x && !BANNED.has(x));
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function pick(a){return a[Math.floor(Math.random()*a.length)]}
function formatNum(n){return (Math.round(n*10)/10).toString().replace(/\.0$/,'')}

function makeAmountQuestion(item){
  const facts=extractFacts(item.formula).filter(f=>!!f.unit && !BANNED.has(f.ingredient));
  if(!facts.length)return null;
  const fact=pick(facts), unit=fact.unit, correctText=formatNum(fact.amount)+unit;
  let options=[];
  if(unit==='匙'||unit==='罐'){
    const base=fact.amount, nums=new Set([base,base-.5,base+.5,base+1,base-1,1,2,3,4]);
    options=Array.from(nums).filter(n=>n>0&&n<=6).map(n=>formatNum(n)+unit).slice(0,6);
  }else{
    const pool=[5,10,15,20,30,40,45,50,60,80,100,120,140,160,180,200,220,240,300];
    const cand=pool.filter(v=>v!==fact.amount).sort((a,b)=>Math.abs(a-fact.amount)-Math.abs(b-fact.amount));
    options=[correctText,...cand.slice(0,3).map(v=>v+unit)];
  }
  options=Array.from(new Set(options));
  if(!options.includes(correctText))options[0]=correctText;
  options=shuffle(options).slice(0,4);
  if(!options.includes(correctText))options[0]=correctText,options=shuffle(options);
  const qtext=`「${item.name}」中，<b>${fact.ingredient}</b>用量是多少？（單選）`;
  return {type:'amount',item,q:qtext,options,answer:correctText,explain:`完整配方：${item.formula}`};
}
function makeIngredientQuestion(item){
  const present=Array.from(new Set(extractFacts(item.formula).map(f=>f.ingredient))).filter(x=>x && !BANNED.has(x));
  if(present.length<2)return null;
  const correct=shuffle(present).slice(0,Math.min(3,Math.max(2,present.length)));
  const distract=shuffle(GLOBAL_INGS.filter(x=>!present.includes(x))).slice(0,5-correct.length);
  const options=shuffle([...correct,...distract]);
  const qtext=`請勾選「${item.name}」的所有正確成分（多選）。`;
  return {type:'ingredient',item,q:qtext,options,correct:new Set(correct),present,explain:`完整：${item.formula}`};
}

/* 狀態與 DOM */
let paper=[],idx=0,score=0,answered=false;
const qtitle=document.getElementById('qtitle');
const optBox=document.getElementById('optBox');
const explain=document.getElementById('explain');
const metaTop=document.getElementById('metaTop');
const ruleCard=document.getElementById('ruleCard');
const qaCard=document.getElementById('qaCard');
const resultCard=document.getElementById('resultCard');
const resultText=document.getElementById('resultText');
const startBtn=document.getElementById('startBtn');
const submitBtn=document.getElementById('submitBtn');
const nextBtn=document.getElementById('nextBtn');
const retryBtn=document.getElementById('retryBtn');

function genPaper(){
  paper=[];const mode=document.getElementById('mode').value;const used=new Set();let guard=0;
  while(paper.length<TOTAL && guard<2000){
    guard++;
    const item=pick(deck);
    const t=(mode==='mixed')?(Math.random()<0.55?'ingredient':'amount'):mode;
    const q=(t==='amount')?makeAmountQuestion(item):makeIngredientQuestion(item);
    if(!q)continue;
    const key=q.q+'|'+('answer'in q?q.answer:Array.from(q.correct||[]).join(','));
    if(used.has(key))continue;
    used.add(key);paper.push(q);
  }
}
function render(){
  if(idx>=paper.length){showResult();return;}
  const q=paper[idx];
  qaCard.style.display='block';resultCard.style.display='none';
  qtitle.innerHTML=`第 ${idx+1} / ${TOTAL} 題｜${q.q}`;
  optBox.innerHTML='';explain.textContent='';answered=false;nextBtn.disabled=true;
  if(q.type==='amount'){
    q.options.forEach((opt,i)=>{const id='o'+i;const row=document.createElement('div');row.className='option';
      row.innerHTML=`<input type="radio" name="opt" id="${id}"><label for="${id}">${['A','B','C','D'][i]}) ${opt}</label>`;optBox.appendChild(row);});
  }else{
    q.options.forEach((opt,i)=>{const id='o'+i;const row=document.createElement('div');row.className='option';
      row.innerHTML=`<input type="checkbox" id="${id}"><label for="${id}">${['A','B','C','D','E'][i]||''}) ${opt}</label>`;optBox.appendChild(row);});
  }
  updateMeta();
}
function updateMeta(){const done=Math.min(idx+(answered?1:0),TOTAL);metaTop.textContent=`進度：${done}/${TOTAL}｜得分：${Math.round(score*10)/10}/100`}

/* 送出答案（修正多選取值索引錯誤 → 正確計分） */
submitBtn.onclick=()=>{
  if(idx>=paper.length)return;
  const q=paper[idx];
  if(q.type==='amount'){
    const inputs=[...optBox.querySelectorAll('input[type=radio]')];
    const sel=inputs.find(x=>x.checked); if(!sel)return;
    answered=true;
    inputs.forEach((ipt)=>{const row=ipt.parentElement;const val=row.querySelector('label').textContent.replace(/^[A-E]\)\s*/,'').trim();
      if(val===q.answer)row.classList.add('ok'); if(ipt.checked && val!==q.answer)row.classList.add('wrong'); ipt.disabled=true;});
    const chosen=sel.nextElementSibling.textContent.replace(/^[A-E]\)\s*/,'').trim();
    if(chosen===q.answer)score+=POINT;
    explain.textContent=q.explain;
  }else{
    const rows=[...optBox.querySelectorAll('.option')];
    const inputs=[...optBox.querySelectorAll('input[type=checkbox]')];

    // 正確蒐集被勾選的值（修正：用原索引對應 rows）
    const selected=new Set();
    inputs.forEach((chk,i)=>{ if(chk.checked){ 
      const v=rows[i].querySelector('label').textContent.replace(/^[A-E]\)\s*/,'').trim();
      selected.add(v);
    }});
    answered=true;

    // 標示
    inputs.forEach((chk,i)=>{
      const row=rows[i];
      const val=row.querySelector('label').textContent.replace(/^[A-E]\)\s*/,'').trim();
      const isCorrect=q.correct.has(val), isSel=chk.checked;
      if(isCorrect){ row.classList.add('ok'); if(!isSel)row.classList.add('miss'); }
      else if(isSel){ row.classList.add('wrong'); }
      chk.disabled=true;
    });

    // 計分（以真正應選個數為分母）
    const unit = POINT / q.correct.size;
    let s = 0;
    selected.forEach(v=>{ s += q.correct.has(v) ? unit : -unit; });
    if(s<0) s=0;
    score += s;

    explain.textContent=`本題得分：${Math.round(s*10)/10} / ${POINT}。完整配方：${q.item.formula}`;
  }
  nextBtn.disabled=false; updateMeta();
};
nextBtn.onclick=()=>{ if(!answered)return; idx++; render(); };

const startBtnEl=document.getElementById('startBtn');
startBtnEl.onclick=()=>{ score=0;idx=0;genPaper();render();ruleCard.style.display='none'; };
retryBtn.onclick=()=>{ score=0;idx=0;genPaper();render();resultCard.style.display='none';ruleCard.style.display='none'; };

function showResult(){
  qaCard.style.display='none';
  const final=Math.round(score*10)/10;
  resultText.textContent=`本次成績：${final.toFixed(1)} 分（滿分 100）`;
  resultCard.style.display='block';
  ruleCard.style.display='block';
}
</script>
</body>
</html>