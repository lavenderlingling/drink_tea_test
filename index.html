<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>飲料配方選擇題</title>
<style>
  :root{
    --card:#ffffffee;
    --muted:#6b7280;
    --ok:#11b381;
    --ok-bg:#eafaf0;
    --bad:#e74c3c;
    --bad-bg:#fdecea;
    --radius:14px;

    /* 全域字級 */
    --fz-base:18px;
    --fz-base-mobile:17px;
  }
  html,body{height:100%;margin:0;font-family:system-ui,"PingFang TC","Noto Sans TC",sans-serif;color:#111}
  html{font-size:var(--fz-base)}
  @media (max-width:768px){ html{font-size:var(--fz-base-mobile)} }
  body{font-size:1rem; line-height:1.8}

  /* 背景：雙層 cross-fade + 白色漸層遮罩 */
  #bgWrap{position:fixed; inset:0; z-index:-2}
  .bgSlide{
    position:absolute; inset:0;
    background-position:center; background-size:cover;
    opacity:0; transition:opacity 1.8s cubic-bezier(.22,.61,.36,1);
  }
  .bgSlide.show{opacity:1}
  #bgMask{
    position:fixed; inset:0; z-index:-1;
    background:linear-gradient(180deg, rgba(255,255,255,.88) 0%,
                                       rgba(255,255,255,.88) 28%,
                                       rgba(255,255,255,.85) 45%,
                                       rgba(255,255,255,.84) 62%,
                                       rgba(255,255,255,.82) 100%);
    pointer-events:none;
  }

  .shell{max-width:1080px;margin:26px auto;padding:0 16px}
  .toolbar{background:var(--card);backdrop-filter:blur(6px);border:1px solid #e5e7eb;border-radius:var(--radius);padding:16px 18px;display:flex;flex-wrap:wrap;gap:12px;align-items:center}
  h1{flex:1 1 100%;text-align:center;margin:0 0 12px;font-size:clamp(24px,2.6vw,36px);letter-spacing:2px}
  .tools{display:flex;gap:10px;align-items:center;flex-wrap:wrap;width:100%}
  label{color:#374151}
  select,button{font-size:1.06rem;padding:12px 18px;border-radius:12px;border:1px solid #d1d5db;background:#fff;cursor:pointer}
  .btn{background:#fff}
  .btn-primary{background:var(--ok);border-color:#0f9e72;color:#fff}
  #metaTop{margin-left:auto;color:var(--muted);font-size:1.06rem}

  /* LOGO 固定左上 */
  #cornerLogo{position:fixed; left:18px; top:10px; width:72px; z-index:10; user-select:none; pointer-events:none}

  /* 規則卡片 */
  .rules{background:var(--card);border:1px solid #e5e7eb;border-radius:var(--radius);padding:16px 18px;margin-top:12px}
  .rules p{margin:20px 0}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #cbd5e1}
  .badge.ok{background:#e7f8f1;color:#0f9e72;border-color:#b5ead6}
  .badge.bad{background:#ffecec;color:#c23b2a;border-color:#ffc9c9}

  /* 題卡 */
  .card{background:var(--card);border:1px solid #e5e7eb;border-radius:var(--radius);padding:18px;margin-top:16px}
  #qtitle{font-size:clamp(18px,2.2vw,24px);font-weight:700;margin:6px 0 12px}
  .option{
    border:1px solid #d8dee6;border-radius:12px;padding:12px 14px;margin:10px 0;
    display:flex;align-items:center;gap:10px;cursor:pointer; user-select:none;
    transition:background .2s, border-color .2s, box-shadow .2s;
  }
  .option:hover{box-shadow:0 1px 0 rgba(0,0,0,.04)}
  .option input{transform:scale(1.1)}
  .option label{flex:1;color:#111}
  .option.correct{border-color:var(--ok);background:var(--ok-bg)}
  .option.wrong{border-color:var(--bad);background:var(--bad-bg)}
  .option.missed{border:2px solid var(--bad)}
  #explain{margin-top:10px;color:#444;display:none}
  #scoreline{font-weight:700;margin-bottom:4px}
  .card-actions{display:flex;gap:10px;margin-top:12px}
  .card-actions .btn{border:1px solid #d1d5db}
  .card-actions .btn-primary{border-color:#0f9e72}

  /* 結果卡片 */
  #summary{display:none;margin-top:16px;background:var(--card);border:1px solid #e5e7eb;border-radius:var(--radius);padding:16px}
  #summary b{font-size:22px}

  /* 手機優化：不改桌機配置 */
  @media (max-width:640px){
    #cornerLogo{left:12px; top:8px; width:58px}
    .toolbar{padding:12px}
    h1{margin:0 0 8px;letter-spacing:1.5px}
    .tools{
      display:grid;
      grid-template-columns: 1fr 1fr;
      grid-template-areas:
        "left left"
        "start meta";
      gap:8px; align-items:center;
    }
    .tools > .left{grid-area:left; display:block; min-width:0}
    .tools > .left > label{display:block; margin-bottom:6px}
    #mode{font-size:1rem; padding:10px 12px; width:100%; max-width:none}
    #startBtn{grid-area:start; font-size:1rem; padding:12px 16px; justify-self:start; white-space:nowrap}
    #metaTop{grid-area:meta; font-size:.95rem; justify-self:end; margin-left:0; white-space:nowrap}

    .card{padding:14px}
    #qtitle{font-size:18px}
    .option{padding:12px 12px}
    .option label{font-size:1.06rem}
  }
</style>
</head>
<body>
  <!-- 左上角 Logo（檔名放同層，例如 logo.png） -->
  <img id="cornerLogo" src="logo.png" alt="logo">

  <!-- 背景：雙圖層 cross-fade -->
  <div id="bgWrap">
    <div id="bgA" class="bgSlide show"></div>
    <div id="bgB" class="bgSlide"></div>
  </div>
  <div id="bgMask"></div>

  <div class="shell">
    <div class="toolbar">
      <h1>飲料配方選擇題</h1>
      <div class="tools">
        <div class="left">
          <label for="mode">題型：</label>
          <select id="mode">
            <option value="mixed">混合（多選成分＋用量）</option>
            <option value="amount">用量題（問某成分幾 cc/g/匙/罐）</option>
            <option value="ingredientAll">成分題（多選：選出所有正確成分）</option>
          </select>
        </div>
        <button id="startBtn" class="btn btn-primary">開始測驗</button>
        <div id="metaTop">進度：0/20｜得分：0/100</div>
      </div>
    </div>

    <div class="rules" id="rules">
      <p>規則：20 題，每題 5 分。</p>
      <p>多選題評分：每題滿分 5 分，正確選一項得 <b>5 / 正確數</b> 分；每多選一個錯誤扣同額（最低 0 分）。</p>
      <p>標示：<span class="badge ok">綠底＝正確成分</span>　<span class="badge bad">紅框＝勾錯或漏選</span></p>
    </div>

    <div class="card" id="card" style="display:none">
      <div id="qtitle"></div>
      <div id="options"></div>

      <!-- 解析 -->
      <div id="explain">
        <div id="scoreline"></div>
        <div id="formula"></div>
      </div>

      <div class="card-actions">
        <button id="submitBtn" class="btn btn-primary">送出答案</button>
        <button id="nextBtn" class="btn">下一題</button>
      </div>
    </div>

    <div id="summary"></div>
  </div>

<script>
/* =============== 背景 Cross-fade 幻燈片 =============== */
(function(){
  const imgs = ["bg1.jpg","bg2.jpg","bg3.jpg","bg4.jpg","bg5.jpg","bg6.jpg"]; // 與 HTML 同層
  const INTERVAL = 12000;
  const slides = [document.getElementById('bgA'), document.getElementById('bgB')];
  let cur = 0, i = 0;
  function setBG(el, url){ el.style.backgroundImage = `url('${url}')`; }

  const first = new Image();
  first.onload = () => { setBG(slides[cur], first.src); slides[cur].classList.add('show'); };
  first.src = imgs[0];

  setInterval(()=> {
    i = (i + 1) % imgs.length;
    const next = cur ^ 1;
    const img = new Image();
    img.onload = () => {
      setBG(slides[next], img.src);
      slides[next].classList.add('show');
      slides[cur].classList.remove('show');
      cur = next;
    };
    img.src = imgs[i];
  }, INTERVAL);
})();

/* ===================== 題庫 ===================== */
const lines = `
錫蘭紅茶｜紅茶；（糖鍵紅茶鍵）
茉香綠茶｜綠茶；（糖鍵原茶鍵）
文山青茶｜青茶；（糖鍵原茶鍵）
玄米煎茶｜玄米；（糖鍵原茶鍵）
碳焙鐵觀音｜鐵觀音；（糖鍵原茶鍵）
冬瓜茶｜冬瓜茶；（不額外加糖）
柳橙百香綠（Ｌ）｜柳橙100cc + 百香20cc + 綠茶；（糖鍵柳橙鍵）
柳橙百香綠（Ｍ）｜柳橙80cc + 百香15cc + 綠茶；（糖鍵柳橙鍵）
奇異果綠茶｜奇異果150g + 檸檬5cc + 綠茶；（糖鍵奇異果綠茶鍵）
鮮榨葡萄柚綠（Ｌ）｜葡萄柚160cc + 綠茶；（糖鍵葡萄柚鍵）
鮮榨葡萄柚綠（M）｜葡萄柚120cc + 綠茶；（糖鍵葡萄柚鍵）
鮮榨葡萄柚青（Ｌ）｜葡萄柚160cc + 青茶；（糖鍵葡萄柚鍵）
鮮榨葡萄柚青（M）｜葡萄柚160cc + 青茶；（糖鍵葡萄柚鍵）
百香奇亞籽｜奇亞籽 + 百香30cc + 檸檬5cc + 紅茶100cc + RO；（糖鍵百香鍵）
檸檬奇亞籽｜奇亞籽 + 檸檬30cc + 紅茶100cc + RO；（糖鍵檸檬鍵）
柳橙奇亞籽｜奇亞籽 + 柳橙120cc + 紅茶100cc + RO；（糖鍵柳橙鍵）
翡翠檸檬紅（Ｌ）｜檸檬40cc + 紅茶；（糖鍵檸檬鍵）
翡翠檸檬紅（M）｜檸檬30cc + 紅茶；（糖鍵檸檬鍵）
翡翠檸檬綠（Ｌ）｜檸檬40cc + 綠茶；（糖鍵檸檬鍵）
翡翠檸檬綠（M）｜檸檬30cc + 綠茶；（糖鍵檸檬鍵）
翡翠檸檬青（Ｌ）｜檸檬40cc + 青茶；（糖鍵檸檬鍵）
翡翠檸檬青（M）｜檸檬30cc + 青茶；（糖鍵檸檬鍵）
鮮榨柳橙綠（Ｌ）｜柳橙160cc + 綠茶；（糖鍵柳橙鍵）
鮮榨柳橙綠（M）｜柳橙120cc + 綠茶；（糖鍵柳橙鍵）
鮮榨柳橙青（Ｌ）｜柳橙160cc + 青茶；（糖鍵柳橙鍵）
鮮榨柳橙青（M）｜柳橙120cc + 青茶；（糖鍵柳橙鍵）
鮮百香紅（Ｌ）｜百香40cc + 檸檬10cc + 紅茶；（糖鍵百香鍵）
鮮百香紅（M）｜百香30cc + 檸檬5cc + 紅茶；（糖鍵百香鍵）
鮮百香綠（Ｌ）｜百香40cc + 檸檬10cc + 綠茶；（糖鍵百香鍵）
鮮百香綠（M）｜百香30cc + 檸檬5cc + 綠茶；（糖鍵百香鍵）
鮮百香青（Ｌ）｜百香40cc + 檸檬10cc + 青茶；（糖鍵百香鍵）
鮮百香青（M）｜百香30cc + 檸檬5cc + 青茶；（糖鍵百香鍵）
蜂蜜紅茶（Ｌ）｜蜂蜜50cc + 紅茶；（不額外加糖）
蜂蜜紅茶（M）｜蜂蜜40cc + 紅茶；（不額外加糖）
蜂蜜綠茶（Ｌ）｜蜂蜜50cc + 綠茶；（不額外加糖）
蜂蜜綠茶（M）｜蜂蜜40cc + 綠茶；（不額外加糖）
毛豆奶昔｜毛豆100g + 鮮奶160cc + RO + 冰塊；（糖鍵冰沙鍵） 
酪梨鮮奶｜酪梨50g + 鮮奶140cc + 冰塊 + RO；（糖鍵酪梨鍵）
酪梨火龍果鮮奶｜酪梨火龍果 + 鮮奶140cc + 冰塊 + RO；（糖鍵酪梨鍵） 
甘蔗檸檬（L）｜甘蔗240cc + 檸檬20cc + RO；（糖鍵白玉甘蔗鍵）
甘蔗檸檬（M）｜甘蔗200cc + 檸檬15cc + RO；（糖鍵白玉甘蔗鍵）
甘蔗金桔（L）｜甘蔗240cc + 金桔20cc + 3顆金桔 + RO；（糖鍵白玉甘蔗鍵）
甘蔗金桔（M）｜甘蔗200cc + 金桔15cc + 3顆金桔 + RO；（糖鍵白玉甘蔗鍵）
甘蔗紅茶（L）｜甘蔗160cc + 紅茶；（糖鍵白玉甘蔗鍵）
甘蔗綠茶（L）｜甘蔗160cc + 綠茶；（糖鍵白玉甘蔗鍵）
甘蔗青茶（L）｜甘蔗160cc + 青茶；（糖鍵白玉甘蔗鍵）
甘蔗紅茶（M）｜甘蔗120cc  + 紅茶 ；（糖鍵白玉甘蔗鍵）
甘蔗綠茶（M）｜甘蔗120cc  + 綠茶 ；（糖鍵白玉甘蔗鍵）
甘蔗青茶（M）｜甘蔗120cc  + 青茶 ；（糖鍵白玉甘蔗鍵）
百香QQ（波霸蘆薈愛玉）｜百香30cc + 檸檬5cc + 波霸 + 蘆薈 + 愛玉 + RO；（糖鍵百香鍵）
檸檬愛玉｜檸檬30cc + 愛玉 + RO；（糖鍵檸檬鍵） 
百香愛玉｜百香30cc + 檸檬5cc + 愛玉 + RO；（糖鍵百香鍵） 
金桔檸檬（L）｜梅汁10cc + 檸檬30cc + 金桔20cc + 百香10cc + 3顆金桔 + RO；（糖鍵檸檬鍵） 
金桔檸檬（M）｜梅汁10cc + 檸檬20cc + 金桔10cc + 百香5cc + 3顆金桔 + RO；（糖鍵檸檬鍵） 
葡萄柚蜜奇亞籽｜蜂蜜40cc + 葡萄柚120cc + 奇亞籽 + RO；（不額外加糖） 
檸檬蘆薈｜檸檬40cc + 蘆薈 + RO；（糖鍵檸檬鍵） 
柳橙蘆薈｜柳橙160cc + 蘆薈 + RO；（糖鍵柳橙鍵） 
橙果粒（蘆薈愛玉）｜柳橙120cc + 蘆薈 + 愛玉 + RO；（糖鍵柳橙鍵） 
柚果粒（蘆薈愛玉）｜葡萄柚120cc + 蘆薈 + 愛玉 + RO；（糖鍵葡萄柚鍵）  
蜂蜜檸檬奇亞籽｜蜂蜜40cc + 檸檬30cc + 奇亞籽 + RO；（不額外加糖）  
金鑽鳳梨雪沙｜鳳梨140g + RO + 冰塊；（糖鍵鳳梨鍵） 
金鑽鳳梨百香｜鳳梨140g + RO + 冰塊 + 百香30cc （加入杯中）；（糖鍵鳳梨鍵） 
金鑽鳳梨百香綠／青｜鳳梨140g + 茶100cc + 冰塊 + 百香30cc （加入杯中）；（糖鍵鳳梨鍵） 
多多綠（L）｜多多2罐 + 茶；（糖鍵多多鍵） 
多多綠（M）｜多多1罐 + 茶；（糖鍵多多鍵）
檸檬多多（L）｜多多2罐 + 檸檬40cc + RO；（糖鍵多多鍵）
檸檬多多（M）｜多多1罐 + 檸檬30cc + RO；（糖鍵多多鍵） 
百香果多多（L）｜多多2罐 + 百香40cc + 檸檬10cc + RO；（糖鍵多多鍵）
百香果多多（M）｜多多1罐 + 百香30cc + 檸檬5cc + RO；（糖鍵多多鍵）
葡萄柚多多（L）｜多多2罐 + 葡萄柚160cc + RO；（糖鍵多多鍵）
葡萄柚多多（M）｜多多1罐 + 葡萄柚120cc + RO；（糖鍵多多鍵）
冬瓜檸檬（L）｜檸檬40cc + RO100 + 冬瓜茶；（不額外加糖） 
冬瓜檸檬（M）｜檸檬30cc +  RO100 + 冬瓜茶；（不額外加糖） 
冬瓜金桔（L）｜金桔40cc + RO100 + 冬瓜茶；（不額外加糖、3顆金桔） 
冬瓜金桔（M）｜金桔30cc  + RO100 + 冬瓜茶；（不額外加糖、3顆金桔） 
芭樂梅｜芭樂180g + RO+ 梅汁10cc + 冰塊；（糖鍵冰沙鍵）
番茄梅｜番茄150g + RO+ 梅汁15cc + 冰塊；（糖鍵冰沙鍵）
芭樂檸檬｜芭樂180g + RO + 梅汁5cc + 檸檬20cc + 冰塊；（糖鍵冰沙鍵）
奇異果雪沙｜奇異果150g + RO  + 冰塊 + 檸檬5cc；（糖鍵冰沙鍵） 
火龍果雪沙｜火龍果150g + RO + 冰塊；（糖鍵冰沙鍵）
芒果雪沙｜芒果100g + RO + 冰塊 + 兩匙芒果丁；（糖鍵冰沙鍵） 
芒果奶酪布丁｜RO + 冰塊 + 鮮奶50cc  + 一匙芒果丁 + 奶酪布丁；（糖鍵冰沙鍵） 
芒果芝芝奶蓋｜RO + 冰塊+ 一匙芒果丁 + 一匙奶酪布丁+ 奶蓋；（糖鍵冰沙鍵） 
可可歐蕾（L）｜可可2匙化開 + 鮮奶80cc + RO + 奶蓋；（糖鍵奶香鍵） 
可可歐蕾（M）｜可可1.5匙化開 + 鮮奶40cc + RO + 奶蓋；（糖鍵奶香鍵） 
黑糖鮮奶（L）｜黑糖45cc + 鮮奶300cc + RO；（不額外加糖）
黑糖鮮奶（M）｜黑糖35cc + 鮮奶220cc + RO；（不額外加糖） 
黑糖鮮奶波霸（L）｜黑糖35cc + 波霸 + 鮮奶220cc + RO；（不額外加糖） 
黑糖鮮奶波霸（M）｜黑糖20cc + 波霸 + 鮮奶180cc + RO；（不額外加糖） 
黑糖奶茶（L）｜黑糖45cc + 錫蘭奶茶；（不額外加糖） 
黑糖奶茶（M）｜黑糖40cc + 錫蘭奶茶；（不額外加糖） 
黑糖波霸奶茶（L）｜黑糖30cc  + 波霸 + 錫蘭奶茶；（不額外加糖） 
黑糖波霸奶茶（M）｜黑糖20cc  + 波霸  + 錫蘭奶茶；（不額外加糖） 
黑糖芋泥鮮奶（M）｜芋泥100cc + 黑糖20cc + 鮮奶220cc；（不額外加糖） 
芋泥鮮奶（M）｜芋泥100cc + 鮮奶；（不額外加糖） 
紅豆鮮奶（L）｜兩匙紅豆 + 鮮奶300cc + RO；（不額外加糖） 
紅豆鮮奶（M）｜兩匙紅豆 +  鮮奶200cc + RO；（不額外加糖） 
紅豆波霸鮮奶（L）｜兩匙紅豆 +  波霸 + 鮮奶300cc + RO；（不額外加糖） 
紅豆波霸鮮奶（M）｜兩匙紅豆 +  波霸 + 鮮奶200cc + RO；（不額外加糖）
波霸鮮奶（L）｜波霸 + 鮮奶200cc + RO；（不額外加糖） 
波霸鮮奶（M）｜波霸 +鮮奶200cc + RO；（不額外加糖）
甘蔗鮮奶（L）｜甘蔗300cc + 鮮奶220cc + RO；（不加糖）
甘蔗鮮奶（M）｜甘蔗200cc + 鮮奶160cc + RO；（不額外加糖）
甘蔗鮮奶（M+料）｜甘蔗140cc + 鮮奶120cc + RO；（不額外加糖）
阿華田鮮奶（L）｜阿華田3匙 + 鮮奶160cc + RO；（糖鍵奶香鍵）
阿華田鮮奶（M）｜阿華田2匙 + 鮮奶120cc + RO；（糖鍵奶香鍵）
阿華田鮮奶（M+料）｜阿華田1匙 + 鮮奶80cc + RO；（糖鍵奶香鍵）
錫蘭紅鮮奶（L）｜鮮奶180cc + 紅茶；（糖鍵奶香鍵）
錫蘭紅鮮奶（M）｜鮮奶140cc  + 紅茶；（糖鍵奶香鍵）
錫蘭紅鮮奶（M+料）｜鮮奶120cc + 紅茶；（糖鍵奶香鍵）
茉香綠鮮奶（L）｜鮮奶180cc + 綠茶；（糖鍵奶香鍵）
茉香綠鮮奶（M）｜鮮奶140cc  + 綠茶；（糖鍵奶香鍵）
茉香綠鮮奶（M+料）｜鮮奶120cc + 綠茶；（糖鍵奶香鍵）
文山青鮮奶（L）｜鮮奶180cc + 青茶；（糖鍵奶香鍵）
文山青鮮奶（M）｜鮮奶140cc  + 青茶；（糖鍵奶香鍵）
文山青鮮奶（M+料）｜鮮奶120cc + 青茶；（糖鍵奶香鍵）
鐵觀音鮮奶（L）｜鮮奶180cc + 鐵觀音；（糖鍵奶香鍵）
鐵觀音鮮奶（M）｜鮮奶140cc  + 鐵觀音；（糖鍵奶香鍵）
鐵觀音鮮奶（M+料）｜鮮奶120cc + 鐵觀音；（糖鍵奶香鍵）
玄米鮮奶（L）｜鮮奶180cc + 玄米；（糖鍵奶香鍵）
玄米鮮奶（M）｜鮮奶140cc  + 玄米；（糖鍵奶香鍵）
玄米鮮奶（M+料）｜鮮奶120cc + 玄米；（糖鍵奶香鍵）
冬瓜鮮奶（L）｜鮮奶160cc + 冬瓜茶；（不額外加糖）
冬瓜鮮奶（M）｜鮮奶120cc + 冬瓜茶；（不額外加糖）
可可鮮奶（L）｜可可2匙 + 鮮奶160cc + RO；（糖鍵奶香鍵）
可可鮮奶（M）｜可可1.5匙 + 鮮奶140cc + RO；（糖鍵奶香鍵）
芝麻鮮奶茶｜芝麻2匙 + 鮮奶140cc + 紅茶；（糖鍵奶香鍵）
錫蘭奶茶｜錫蘭奶茶；（糖鍵奶香鍵）
茉香奶茶（L）｜綠茶 + 奶精4匙；（糖鍵奶香鍵）
茉香奶茶（M）｜綠茶 + 奶精3匙；（糖鍵奶香鍵）
茉香奶茶（M+料）｜綠茶 + 奶精2匙；（糖鍵奶香鍵）
文山青奶茶（L）｜青茶 + 奶精4匙；（糖鍵奶香鍵）
文山青奶茶（M）｜青茶 + 奶精3匙；（糖鍵奶香鍵）
文山青奶茶（M+料）｜青茶 + 奶精2匙；（糖鍵奶香鍵）
鐵觀音奶茶（L）｜鐵觀音 + 奶精4匙；（糖鍵奶香鍵）
鐵觀音奶茶（M）｜鐵觀音 + 奶精3匙；（糖鍵奶香鍵）
鐵觀音奶茶（M+料）｜鐵觀音 + 奶精2匙；（糖鍵奶香鍵）
玄米奶茶（L）｜玄米 + 奶精4匙；（糖鍵奶香鍵）
玄米奶茶（M）｜玄米 + 奶精3匙；（糖鍵奶香鍵）
玄米奶茶（M+料）｜玄米 + 奶精2匙；（糖鍵奶香鍵）
紅豆波霸奶茶（L）｜紅豆 + 波霸 + 錫蘭奶茶；（糖鍵奶香鍵）
紅豆波霸奶茶（M+料）｜紅豆 + 波霸 + 錫蘭奶茶；（糖鍵奶香鍵）
可可奶茶（L）｜錫蘭奶茶 + 可可2匙；（糖鍵奶香鍵）
可可奶茶（M）｜錫蘭奶茶 + 可可1.5匙；（糖鍵奶香鍵）
可可奶茶（M+料）｜錫蘭奶茶 + 可可1匙；（糖鍵奶香鍵）
阿華田（L）｜RO + 阿華田3匙 + 奶精3匙；（糖鍵奶香鍵）
阿華田（M）｜RO + 阿華田2匙 + 奶精2匙；（糖鍵奶香鍵）
阿華田（M+料）｜RO + 阿華田1匙 + 奶精1匙；（糖鍵奶香鍵）
奶酪布丁奶茶（L）｜奶酪布丁 + 錫蘭奶茶；（糖鍵奶香鍵）
奶酪布丁奶茶（M+料）｜奶酪布丁 + 錫蘭奶茶；（糖鍵奶香鍵）
白鬍子奶蓋紅｜紅茶 + 奶蓋；（糖鍵紅茶鍵）
白鬍子奶蓋綠｜綠茶 + 奶蓋；（糖鍵原茶鍵）
白鬍子奶蓋青｜青茶 + 奶蓋；（糖鍵原茶鍵）
白鬍子奶蓋玄米｜玄米 + 奶蓋；（糖鍵原茶鍵）
白鬍子奶蓋鐵觀音｜鐵觀音 + 奶蓋；（糖鍵原茶鍵）
芝麻奶茶（L）｜芝麻粉2匙 + 錫蘭奶茶；（糖鍵奶香鍵）
芝麻奶茶（M）｜芝麻粉1.5匙 + 錫蘭奶茶；（糖鍵奶香鍵）
杏仁奶茶（L）｜杏仁粉2匙 + 錫蘭奶茶；（糖鍵奶香鍵）
杏仁奶茶（M）｜杏仁粉1.5匙 + 錫蘭奶茶；（糖鍵奶香鍵）
水蜜桃雪沙｜水蜜桃果粒50g + RO + 冰塊；（糖鍵冰沙鍵）
水蜜桃紅｜水蜜桃果粒100g + 紅茶；（糖鍵柳橙鍵）
水蜜桃綠｜水蜜桃果粒100g + 綠茶；（糖鍵柳橙鍵）
水蜜桃青｜水蜜桃果粒100g + 青茶；（糖鍵柳橙鍵）
蜜桃檸檬紅｜水蜜桃果粒100g + 檸檬10cc + 紅茶；（糖鍵柳橙鍵）
蜜桃檸檬綠｜水蜜桃果粒100g + 檸檬10cc + 綠茶；（糖鍵柳橙鍵）
蜜桃檸檬青｜水蜜桃果粒100g + 檸檬10cc + 青茶；（糖鍵柳橙鍵）
`;

/* ============= 成分總表與同義詞（過濾糖/茶、同義規則） ============= */
const ING_MASTER = [
  'RO','冰塊',
  '紅茶','綠茶','青茶','鐵觀音','玄米','冬瓜茶','錫蘭奶茶',
  '鳳梨','芒果','奇異果','火龍果','番茄','酪梨','毛豆','水蜜桃','芭樂','葡萄柚','柳橙',
  '蜂蜜','黑糖','奶精','阿華田','可可粉','芝麻粉','杏仁粉','芋泥','紅豆','杏仁凍','奇亞籽','梅汁','金桔','奶蓋','芒果丁',
  '波霸','愛玉','蘆薈','仙草','奶酪布丁','多多','鮮奶',
  '百香','檸檬','甘蔗汁'
];
const ALIASES = {
  '錫蘭紅茶':'紅茶','茉香綠茶':'綠茶','文山青茶':'青茶','碳焙鐵觀音':'鐵觀音','玄米煎茶':'玄米',
  '百香果':'百香','檸檬汁':'檸檬','金桔汁':'金桔','柳橙汁':'柳橙','葡萄柚汁':'葡萄柚',
  '阿華田粉':'阿華田','可可':'可可粉','芝麻':'芝麻粉',
  '芒樂':'芭樂','甘蔗':'甘蔗汁'
};
const STOPWORDS_RE = /(加糖|糖鍵|不額外加糖|杯中|加入|補|至|去冰|退杯|化開|鍵|不足|滿|顆|罐|匙|分滿|L|M|\+茶|茶100)/;

/* 工具 */
function cn2num(txt){
  const map={'零':0,'一':1,'二':2,'兩':2,'三':3,'四':4,'五':5,'六':6,'七':7,'八':8,'九':9,'十':10};
  if(/^\d+(\.\d+)?$/.test(txt)) return parseFloat(txt);
  if(txt==='十') return 10;
  let m=txt.match(/^十([一二三四五六七八九])$/); if(m) return 10+map[m[1]];
  m=txt.match(/^([一二三四五六七八九])十([一二三四五六七八九])?$/); if(m) return map[m[1]]*10+(m[2]?map[m[2]]:0);
  m=txt.match(/^([一二三四五六七八九])$/); if(m) return map[m[1]];
  return NaN;
}
function normalizeIngredient(s){
  let ing=(s||'').toString().trim();
  ing=ing.replace(/[；;、。，（）()]/g,'').replace(/\s+/g,'');
  if(!ing || STOPWORDS_RE.test(ing)) return null;
  if(ALIASES[ing]) ing=ALIASES[ing];
  if(/^RO\d+/.test(ing)) ing='RO';
  if(ing==='茶') return null; // 不出現通用「茶」
  if(ing==='糖') return null; // 永不出現「糖」
  return ing;
}

/* 解析配方 */
function extractFacts(formula){
  const facts=[]; const text=(formula||'').replace(/\s+/g,' ').trim();
  const presentSet=new Set();

  // 依 master 掃過（是否出現）
  for(const raw of ING_MASTER){
    const tag=normalizeIngredient(raw); if(!tag) continue;
    if(text.includes(tag)) presentSet.add(tag);
  }
  for(const k in ALIASES){ if(text.includes(k)) presentSet.add(normalizeIngredient(k)); }

  // 數量模式
  const pairA=/([一二兩三四五六七八九十\d\.]+)\s*(cc|g|匙|顆|罐)\s*([A-Za-z\u4e00-\u9fa5（）()]+?)(?=[+；;、，\s]|$)/g;
  const pairB=/([A-Za-z\u4e00-\u9fa5（）()]+?)\s*([一二兩三四五六七八九十\d\.]+)\s*(cc|g|匙|顆|罐)/g;
  let m;
  while((m=pairA.exec(text))!==null){
    const amount=cn2num(m[1]), unit=m[2], ing=normalizeIngredient(m[3]);
    if(ing && !isNaN(amount)) facts.push({ingredient:ing,amount,unit});
  }
  while((m=pairB.exec(text))!==null){
    const ing=normalizeIngredient(m[1]), amount=cn2num(m[2]), unit=m[3];
    if(ing && !isNaN(amount)) facts.push({ingredient:ing,amount,unit});
  }
  const mRO=text.match(/RO\s*?(\d+)/); if(mRO) facts.push({ingredient:'RO',amount:parseInt(mRO[1],10),unit:'cc'});

  for(const ing of presentSet){ if(!facts.some(f=>f.ingredient===ing)) facts.push({ingredient:ing,amount:null,unit:''}); }
  const seen={}; return facts.filter(f=>{const k=f.ingredient+'|'+(f.amount??'')+'|'+(f.unit||''); if(seen[k])return false; seen[k]=1; return true;});
}

/* 準備題庫 */
const deck = lines.split(/\n+/).map(l=>l.trim()).filter(Boolean).map(l=>{
  const p=l.split(/\s*[\|｜]\s*/); return {name:p[0], formula:p[1]||""};
});
const GLOBAL_POOL = Array.from(new Set(
  deck.flatMap(d=>extractFacts(d.formula).map(f=>f.ingredient)).concat(ING_MASTER)
)).filter(Boolean);

function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]} return a; }
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

/* 生成「用量題」 */
function makeAmountQuestion(item){
  const facts=extractFacts(item.formula).filter(f=>f.unit);
  if(!facts.length) return null;
  const fact=pick(facts), correctText=`${fact.amount}${fact.unit}`;
  let wrongNums=[];
  if(['匙','罐','顆'].includes(fact.unit)){
    const base=[1,2,3,4,5].filter(n=>n!==fact.amount);
    wrongNums = shuffle(base).slice(0,2).concat([fact.amount+(fact.amount>=3?-1:1)]);
    wrongNums=[...new Set(wrongNums)].slice(0,3);
  }else{
    const pool=[30,40,45,50,60,80,100,120,140,160,180,200,220,240,300].filter(v=>v!==fact.amount)
      .sort((a,b)=>Math.abs(a-fact.amount)-Math.abs(b-fact.amount));
    wrongNums=pool.slice(0,3);
  }
  const options=shuffle([correctText, ...wrongNums.map(v=>`${v}${fact.unit}`)]);
  return {type:'amount',multi:false,q:`「${item.name}」中，<b>${fact.ingredient}</b> 用量是多少？`,options,answer:correctText,explain:`完整配方：${item.formula}`};
}

/* 生成「多選成分題」 */
function makeIngredientQuestion(item){
  const facts=extractFacts(item.formula);
  const present=Array.from(new Set(facts.map(f=>f.ingredient))).filter(Boolean);
  if(present.length<2) return null;
  let correctPick = shuffle(present).slice(Math.min(2,present.length-1), Math.min(4,present.length));
  if(correctPick.length<2) correctPick = shuffle(present).slice(0,2);
  const absent = GLOBAL_POOL.filter(x=>!present.includes(x));
  const wrongs = shuffle(absent.filter(x=>x!=='糖' && x!=='加糖' && x!=='茶')).slice(0, 5 - correctPick.length);
  const opts = shuffle([...correctPick, ...wrongs]);
  return {type:'ingredientAll',multi:true,q:`請勾選「${item.name}」的所有正確成分（多選）。`,options:opts,correctSet:new Set(correctPick),explain:`完整配方：${item.formula}`};
}

/* 組 20 題 */
const TOTAL=20, POINT=5;
let paper=[], idx=0, totalScore=0, answered=false;

function buildOne(mode){
  let guard=0,q=null;
  while(!q && guard<200){
    guard++;
    const item=pick(deck);
    const m=(mode==='mixed') ? (Math.random()<0.5?'amount':'ingredientAll') : mode;
    q=(m==='amount')?makeAmountQuestion(item):makeIngredientQuestion(item);
  }
  return q;
}
function genPaper(){
  paper=[]; const seen=new Set(); const mode=document.getElementById('mode').value;
  while(paper.length<TOTAL){
    const q=buildOne(mode); if(!q) continue;
    const key=q.q+'|'+(q.answer||[...q.correctSet].join(',')); if(seen.has(key)) continue;
    seen.add(key); paper.push(q);
  }
}

/* UI */
const qtitle=document.getElementById('qtitle');
const optionsBox=document.getElementById('options');
const metaTop=document.getElementById('metaTop');
const explainBox=document.getElementById('explain');
const scoreline=document.getElementById('scoreline');
const formulaLine=document.getElementById('formula');

function updateMeta(){
  metaTop.textContent=`進度：${Math.min(idx+(answered?1:0),TOTAL)}/${TOTAL}｜得分：${totalScore.toFixed(1)}/${TOTAL*POINT}`;
}
function renderCurrent(){
  if(idx>=paper.length){ showSummary(); return; }
  const q=paper[idx];
  document.getElementById('card').style.display='block';
  document.getElementById('summary').style.display='none';
  qtitle.innerHTML=`第 ${idx+1} / ${TOTAL} 題｜${q.q}`;
  optionsBox.innerHTML=''; explainBox.style.display='none';
  document.getElementById('submitBtn').disabled=false;
  document.getElementById('nextBtn').disabled=true;
  answered=false; updateMeta();

  const letters=['A','B','C','D','E'];
  q.options.forEach((opt,i)=>{
    const wrap=document.createElement('div'); wrap.className='option'; wrap.dataset.value=opt;
    const input=document.createElement('input'); input.type=q.multi?'checkbox':'radio'; input.name='opt';
    const lab=document.createElement('label'); lab.innerHTML=`<b>${letters[i]})</b> ${opt}`;
    wrap.appendChild(input); wrap.appendChild(lab); optionsBox.appendChild(wrap);

    /* 讓整個方框可點（單選互斥、多選可勾多個） */
    wrap.addEventListener('click', (e)=>{
      if(answered) return;
      // 避免點到 input 時被預設行為與手動切換重複
      if(e.target.tagName !== 'INPUT') e.preventDefault();
      if(q.multi){
        input.checked = !input.checked;
      }else{
        [...optionsBox.querySelectorAll('input')].forEach(el=>el.checked=false);
        input.checked=true;
      }
    });
  });
}

/* 多選計分 */
function scoreMulti(q, chosenArr){
  const correct=q.correctSet;
  const inOptionsCorrect=q.options.filter(o=>correct.has(o));
  const per=POINT/inOptionsCorrect.length;

  const map=new Map(); [...optionsBox.children].forEach(div=>map.set(div.dataset.value,div));
  let add=0;
  chosenArr.forEach(v=>{
    if(correct.has(v)){ add+=per; map.get(v).classList.add('correct'); }
    else{ map.get(v).classList.add('wrong'); add-=per; }
  });
  inOptionsCorrect.forEach(v=>{ if(!chosenArr.includes(v)) map.get(v).classList.add('missed'); });

  if(add<0) add=0;
  return Math.round(add*10)/10;
}

/* 送出答案 */
document.getElementById('submitBtn').onclick=()=>{
  if(answered) return;
  const q=paper[idx];
  const chosen=[...optionsBox.querySelectorAll('input')].filter(el=>el.checked).map(el=>el.parentElement.dataset.value);
  let add=0;

  if(q.type==='amount'){
    const map=new Map(); [...optionsBox.children].forEach(div=>map.set(div.dataset.value,div));
    map.get(q.answer).classList.add('correct');
    if(chosen.length && chosen[0]===q.answer) add=POINT;
    else if(chosen.length) map.get(chosen[0]).classList.add('wrong');
  }else{
    add=scoreMulti(q, chosen);
  }

  totalScore+=add;
  scoreline.textContent=`本題得分：${add} / ${POINT}`;
  formulaLine.textContent=q.explain;
  explainBox.style.display='block';

  answered=true; updateMeta();
  document.getElementById('nextBtn').disabled=false;
  document.getElementById('submitBtn').disabled=true;
};

/* 下一題 */
document.getElementById('nextBtn').onclick=()=>{ if(!answered) return; idx++; renderCurrent(); };

/* 總結/開始 */
function showSummary(){
  const sum=document.getElementById('summary');
  sum.style.display='block'; document.getElementById('card').style.display='none';
  const score=Math.round(totalScore*10)/10;
  sum.innerHTML=`<b>本次成績：${score} 分（滿分 ${TOTAL*POINT}）</b><br><br><button class="btn btn-primary" id="retry">再試一次</button>`;
  document.getElementById('rules').style.display='block';
  document.getElementById('retry').onclick=startExam;
}
function startExam(){
  idx=0; totalScore=0; answered=false;
  genPaper(); renderCurrent(); updateMeta();
  document.getElementById('rules').style.display='none';
}
document.getElementById('startBtn').onclick=startExam;
</script>
</body>
</html>
