<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>飲料配方練習（20題｜含多選）</title>
<style>
  :root{
    --brand:#18a570;
    --ok:#2ecc71;
    --bad:#e74c3c;
    --text:#1f2937;
    --card:#ffffffee;
    --radius:14px;
    /* ↓ 讓背景更清楚：把白色遮罩稍微變薄 */
    --bgOpacity:.82;
  }
  .bg{ position:fixed; inset:0; z-index:-3; background:center/cover no-repeat; transition:opacity 1.2s ease; }
  .bg.hidden{ opacity:0 }
  .scrim{ position:fixed; inset:0; z-index:-2; background:linear-gradient(rgba(255,255,255,var(--bgOpacity)),rgba(255,255,255,var(--bgOpacity))); pointer-events:none; }

  html,body{height:100%}
  body{ margin:0; color:var(--text); font-family:system-ui,"PingFang TC","Noto Sans TC",sans-serif; display:flex; justify-content:center; }
  .container{ width:min(980px,92vw); padding:28px 0 48px }

  .brand-logo{ position:fixed; top:16px; left:18px; z-index:5; width:min(12vw,90px); height:auto; opacity:.96; filter:drop-shadow(0 4px 10px rgba(0,0,0,.25)); pointer-events:none; }
  .toolbar{ background:var(--card); backdrop-filter:blur(6px); border:1px solid #e5e7eb; border-radius:var(--radius); padding:14px 16px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
  .pill{width:16px;height:16px;background:var(--brand);border-radius:9999px;margin-right:6px}
  h1{margin:0 10px 0 0; font-size:22px}
  select,button{font-size:16px;padding:10px 14px;border-radius:10px;border:1px solid #d1d5db;background:#f7f7f7;cursor:pointer}
  .btn-primary{background:#11b381;color:#fff;border-color:#0f9e72}
  .btn-ghost{background:#fff}
  #meta{margin-left:auto;color:#6b7280;font-size:15px}

  .card{background:var(--card);border:1px solid #e5e7eb;border-radius:var(--radius);padding:18px;margin-top:14px}
  .rules{font-size:17px;line-height:1.85}
  .rules .spacer{display:block;height:12px}

  #card{display:none}
  #q{font-size:22px;font-weight:700;margin-bottom:8px}
  .opt{ position:relative;border:1px solid #e5e7eb;border-radius:12px;padding:12px 14px;margin:9px 0;background:#fff;display:flex;align-items:center;gap:10px;transition:border .15s,background .15s,box-shadow .15s; }
  .opt input{transform:scale(1.15)}
  .opt.correct{background:#eafaf0;border-color:var(--ok)}
  .opt.missed{box-shadow:inset 0 0 0 3px var(--bad)}
  .opt.wrong{box-shadow:inset 0 0 0 2px var(--bad)}

  #explain{margin-top:8px;color:#374151;font-size:16px}
  .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}

  .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:13px;border:1px solid #d1d5db;background:#fff;color:#374151}
  .badge.ok{background:#eafaf0;border-color:#2ecc71}
  .badge.err{background:#fff;border-color:#e74c3c;color:#e74c3c}

  /* ↓ 成績行加大字體 */
  .final-score{font-size:26px;line-height:1.6}
</style>
</head>
<body>
  <div id="bgA" class="bg"></div>
  <div id="bgB" class="bg hidden"></div>
  <div class="scrim"></div>

  <img class="brand-logo" src="logo.png" alt="菓點子 Fresh Idea">

  <div class="container">
    <div class="toolbar">
      <span class="pill"></span><h1>飲料配方選擇題（20題・每題 5 分｜含多選）</h1>
      <label>題型：</label>
      <select id="mode">
        <option value="mixed">混合（多選成分＋用量）</option>
        <option value="amount">用量題（問某成分幾 cc / g / 匙 / 罐 / 顆）</option>
        <option value="multi">多選成分（請勾選所有正確成分）</option>
      </select>
      <button id="start" class="btn-primary">開始測驗</button>
      <span id="meta">進度：0/20｜得分：0/100</span>
    </div>

    <div class="card">
      <div class="rules">
        <div>規則：20 題，每題 5 分。</div>
        <span class="spacer"></span>
        <div>多選題評分：每題滿分 5 分，正確選一項得 <b>5 / 正確數</b> 分；每多選一個錯誤扣同額（最低 0 分）。</div>
        <div>標示：
          <span class="badge ok">綠底＝正確成分</span>
          <span class="badge err">紅框＝勾錯或漏選</span>
        </div>
      </div>
    </div>

    <div id="card" class="card">
      <div id="q"></div>
      <div id="options"></div>
      <div id="explain"></div>
      <div class="actions">
        <button id="submit" class="btn-ghost" disabled>送出答案</button>
        <button id="next" class="btn-ghost" disabled>下一題</button>
      </div>
    </div>

    <div id="summary" class="card" style="display:none"></div>
  </div>

<script>
/* ---- 基本設定 ---- */
const TOTAL = 20, POINT = 5;
const BG_INTERVAL = 10000;
const BG_LIST = ['bg-1.jpg','bg-2.jpg','bg-3.jpg','bg-4.jpg','bg-5.jpg','bg-6.jpg'];

const EXCLUDE_OPTIONS = new Set(['糖','加糖','茶']);
const ALIASES = {
  '錫蘭紅茶':'紅茶','茉香綠茶':'綠茶','文山青茶':'青茶','碳焙鐵觀音':'鐵觀音','玄米煎茶':'玄米',
  '芝麻':'芝麻粉',
  '甘蔗':'甘蔗汁','甘蔗汁':'甘蔗汁',
  '芒樂':'芭樂'
};
const STOP_RE = /(補|至|去冰|加入|加料|退杯|淋上|鍵|滿|尖杯|不足|杯中|化開|不額外加糖)/;


/* ------------------ 題庫（完整配方） ------------------ */
const lines = `
錫蘭紅茶｜紅茶；（糖鍵紅茶鍵）
茉香綠茶｜綠茶；（糖鍵原茶鍵）
文山青茶｜青茶；（糖鍵原茶鍵）
玄米煎茶｜玄米；（糖鍵原茶鍵）
碳焙鐵觀音｜鐵觀音；（糖鍵原茶鍵）
冬瓜茶｜冬瓜茶；（不額外加糖）
柳橙百香綠（Ｌ）｜柳橙100cc + 百香20cc + 綠茶；（糖鍵柳橙鍵）
柳橙百香綠（Ｍ）｜柳橙80cc + 百香15cc + 綠茶；（糖鍵柳橙鍵）
奇異果綠茶｜奇異果150g + 檸檬5cc + 綠茶；（糖鍵奇異果綠茶鍵）
鮮榨葡萄柚綠（Ｌ）｜葡萄柚160cc + 綠茶；（糖鍵葡萄柚鍵）
鮮榨葡萄柚綠（M）｜葡萄柚120cc + 綠茶；（糖鍵葡萄柚鍵）
鮮榨葡萄柚青（Ｌ）｜葡萄柚160cc + 青茶；（糖鍵葡萄柚鍵）
鮮榨葡萄柚青（M）｜葡萄柚160cc + 青茶；（糖鍵葡萄柚鍵）
百香奇亞籽｜奇亞籽 + 百香30cc + 檸檬5cc + 紅茶100cc + RO；（糖鍵百香鍵）
檸檬奇亞籽｜奇亞籽 + 檸檬30cc + 紅茶100cc + RO；（糖鍵檸檬鍵）
柳橙奇亞籽｜奇亞籽 + 柳橙120cc + 紅茶100cc + RO；（糖鍵柳橙鍵）
翡翠檸檬紅（Ｌ）｜檸檬40cc + 紅茶；（糖鍵檸檬鍵）
翡翠檸檬紅（M）｜檸檬30cc + 紅茶；（糖鍵檸檬鍵）
翡翠檸檬綠（Ｌ）｜檸檬40cc + 綠茶；（糖鍵檸檬鍵）
翡翠檸檬綠（M）｜檸檬30cc + 綠茶；（糖鍵檸檬鍵）
翡翠檸檬青（Ｌ）｜檸檬40cc + 青茶；（糖鍵檸檬鍵）
翡翠檸檬青（M）｜檸檬30cc + 青茶；（糖鍵檸檬鍵）
鮮榨柳橙綠（Ｌ）｜柳橙160cc + 綠茶；（糖鍵柳橙鍵）
鮮榨柳橙綠（M）｜柳橙120cc + 綠茶；（糖鍵柳橙鍵）
鮮榨柳橙青（Ｌ）｜柳橙160cc + 青茶；（糖鍵柳橙鍵）
鮮榨柳橙青（M）｜柳橙120cc + 青茶；（糖鍵柳橙鍵）
鮮百香紅（Ｌ）｜百香40cc + 檸檬10cc + 紅茶；（糖鍵百香鍵）
鮮百香紅（M）｜百香30cc + 檸檬5cc + 紅茶；（糖鍵百香鍵）
鮮百香綠（Ｌ）｜百香40cc + 檸檬10cc + 綠茶；（糖鍵百香鍵）
鮮百香綠（M）｜百香30cc + 檸檬5cc + 綠茶；（糖鍵百香鍵）
鮮百香青（Ｌ）｜百香40cc + 檸檬10cc + 青茶；（糖鍵百香鍵）
鮮百香青（M）｜百香30cc + 檸檬5cc + 青茶；（糖鍵百香鍵）
蜂蜜紅茶（Ｌ）｜蜂蜜50cc + 紅茶；（不額外加糖）
蜂蜜紅茶（M）｜蜂蜜40cc + 紅茶；（不額外加糖）
蜂蜜綠茶（Ｌ）｜蜂蜜50cc + 綠茶；（不額外加糖）
蜂蜜綠茶（M）｜蜂蜜40cc + 綠茶；（不額外加糖）
毛豆奶昔｜毛豆100g + 鮮奶160cc + RO + 冰塊；（糖鍵冰沙鍵） 
酪梨鮮奶｜酪梨50g + 鮮奶140cc + 冰塊 + RO；（糖鍵酪梨鍵）
酪梨火龍果鮮奶｜酪梨火龍果 + 鮮奶140cc + 冰塊 + RO；（糖鍵酪梨鍵） 
甘蔗檸檬（L）｜甘蔗240cc + 檸檬20cc + RO；（糖鍵白玉甘蔗鍵）
甘蔗檸檬（M）｜甘蔗200cc + 檸檬15cc + RO；（糖鍵白玉甘蔗鍵）
甘蔗金桔（L）｜甘蔗240cc + 金桔20cc + 3顆金桔 + RO；（糖鍵白玉甘蔗鍵）
甘蔗金桔（M）｜甘蔗200cc + 金桔15cc + 3顆金桔 + RO；（糖鍵白玉甘蔗鍵）
甘蔗紅茶（L）｜甘蔗160cc + 紅茶；（糖鍵白玉甘蔗鍵）
甘蔗綠茶（L）｜甘蔗160cc + 綠茶；（糖鍵白玉甘蔗鍵）
甘蔗青茶（L）｜甘蔗160cc + 青茶；（糖鍵白玉甘蔗鍵）
甘蔗紅茶（M）｜甘蔗120cc  + 紅茶 ；（糖鍵白玉甘蔗鍵）
甘蔗綠茶（M）｜甘蔗120cc  + 綠茶 ；（糖鍵白玉甘蔗鍵）
甘蔗青茶（M）｜甘蔗120cc  + 青茶 ；（糖鍵白玉甘蔗鍵）
百香QQ（波霸蘆薈愛玉）｜百香30cc + 檸檬5cc + 波霸 + 蘆薈 + 愛玉 + RO；（糖鍵百香鍵）
檸檬愛玉｜檸檬30cc + 愛玉 + RO；（糖鍵檸檬鍵） 
百香愛玉｜百香30cc + 檸檬5cc + 愛玉 + RO；（糖鍵百香鍵） 
金桔檸檬（L）｜梅汁10cc + 檸檬30cc + 金桔20cc + 百香10cc + 3顆金桔 + RO；（糖鍵檸檬鍵） 
金桔檸檬（M）｜梅汁10cc + 檸檬20cc + 金桔10cc + 百香5cc + 3顆金桔 + RO；（糖鍵檸檬鍵） 
葡萄柚蜜奇亞籽｜蜂蜜40cc + 葡萄柚120cc + 奇亞籽 + RO；（不額外加糖） 
檸檬蘆薈｜檸檬40cc + 蘆薈 + RO；（糖鍵檸檬鍵） 
柳橙蘆薈｜柳橙160cc + 蘆薈 + RO；（糖鍵柳橙鍵） 
橙果粒（蘆薈愛玉）｜柳橙120cc + 蘆薈 + 愛玉 + RO；（糖鍵柳橙鍵） 
柚果粒（蘆薈愛玉）｜葡萄柚120cc + 蘆薈 + 愛玉 + RO；（糖鍵葡萄柚鍵）  
蜂蜜檸檬奇亞籽｜蜂蜜40cc + 檸檬30cc + 奇亞籽 + RO；（不額外加糖）  
金鑽鳳梨雪沙｜鳳梨140g + RO + 冰塊；（糖鍵鳳梨鍵） 
金鑽鳳梨百香｜鳳梨140g + RO + 冰塊 + 百香30cc （加入杯中）；（糖鍵鳳梨鍵） 
金鑽鳳梨百香綠／青｜鳳梨140g + 茶100cc + 冰塊 + 百香30cc （加入杯中）；（糖鍵鳳梨鍵） 
多多綠（L）｜多多2罐 + 茶；（糖鍵多多鍵） 
多多綠（M）｜多多1罐 + 茶；（糖鍵多多鍵）
檸檬多多（L）｜多多2罐 + 檸檬40cc + RO；（糖鍵多多鍵）
檸檬多多（M）｜多多1罐 + 檸檬30cc + RO；（糖鍵多多鍵） 
百香果多多（L）｜多多2罐 + 百香40cc + 檸檬10cc + RO；（糖鍵多多鍵）
百香果多多（M）｜多多1罐 + 百香30cc + 檸檬5cc + RO；（糖鍵多多鍵）
葡萄柚多多（L）｜多多2罐 + 葡萄柚160cc + RO；（糖鍵多多鍵）
葡萄柚多多（M）｜多多1罐 + 葡萄柚120cc + RO；（糖鍵多多鍵）
冬瓜檸檬（L）｜檸檬40cc + RO100 + 冬瓜茶；（不額外加糖） 
冬瓜檸檬（M）｜檸檬30cc +  RO100 + 冬瓜茶；（不額外加糖） 
冬瓜金桔（L）｜金桔40cc + RO100 + 冬瓜茶；（不額外加糖、3顆金桔） 
冬瓜金桔（M）｜金桔30cc  + RO100 + 冬瓜茶；（不額外加糖、3顆金桔） 
芒樂梅｜芒樂180g + RO+ 梅汁10cc + 冰塊；（糖鍵冰沙鍵）
番茄梅｜番茄150g + RO+ 梅汁15cc + 冰塊；（糖鍵冰沙鍵）
芒樂檸檬｜芒樂180g + RO + 梅汁5cc + 檸檬20cc + 冰塊；（糖鍵冰沙鍵）
奇異果雪沙｜奇異果150g + RO  + 冰塊 + 檸檬5cc；（糖鍵冰沙鍵） 
火龍果雪沙｜火龍果150g + RO + 冰塊；（糖鍵冰沙鍵）
芒果雪沙｜芒果100g + RO + 冰塊 + 兩匙芒果丁；（糖鍵冰沙鍵） 
芒果奶酪布丁｜RO + 冰塊 + 鮮奶50cc  + 一匙芒果丁 + 奶酪布丁；（糖鍵冰沙鍵） 
芒果芝芝奶蓋｜RO + 冰塊+ 一匙芒果丁 + 一匙奶酪布丁+ 奶蓋；（糖鍵冰沙鍵） 
可可歐蕾（L）｜可可2匙化開 + 鮮奶80cc + RO + 奶蓋；（糖鍵奶香鍵） 
可可歐蕾（M）｜可可1.5匙化開 + 鮮奶40cc + RO + 奶蓋；（糖鍵奶香鍵） 
黑糖鮮奶（L）｜黑糖45cc + 鮮奶300cc + RO；（不額外加糖）
黑糖鮮奶（M）｜黑糖35cc + 鮮奶220cc + RO；（不額外加糖） 
黑糖鮮奶波霸（L）｜黑糖35cc + 波霸 + 鮮奶220cc + RO；（不額外加糖） 
黑糖鮮奶波霸（M）｜黑糖20cc + 波霸 + 鮮奶180cc + RO；（不額外加糖） 
黑糖奶茶（L）｜黑糖45cc + 錫蘭奶茶；（不額外加糖） 
黑糖奶茶（M）｜黑糖40cc + 錫蘭奶茶；（不額外加糖） 
黑糖波霸奶茶（L）｜黑糖30cc  + 波霸 + 錫蘭奶茶；（不額外加糖） 
黑糖波霸奶茶（M）｜黑糖20cc  + 波霸  + 錫蘭奶茶；（不額外加糖） 
黑糖芋泥鮮奶（M）｜芋泥100cc + 黑糖20cc + 鮮奶220cc；（不額外加糖） 
芋泥鮮奶（M）｜芋泥100cc + 鮮奶；（不額外加糖） 
紅豆鮮奶（L）｜兩匙紅豆 + 鮮奶300cc + RO；（不額外加糖） 
紅豆鮮奶（M）｜兩匙紅豆 +  鮮奶200cc + RO；（不額外加糖） 
紅豆波霸鮮奶（L）｜兩匙紅豆 +  波霸 + 鮮奶300cc + RO；（不額外加糖） 
紅豆波霸鮮奶（M）｜兩匙紅豆 +  波霸 + 鮮奶200cc + RO；（不額外加糖）
波霸鮮奶（L）｜波霸 + 鮮奶200cc + RO；（不額外加糖） 
波霸鮮奶（M）｜波霸 +鮮奶200cc + RO；（不額外加糖）
甘蔗鮮奶（L）｜甘蔗300cc + 鮮奶220cc + RO；（不加糖）
甘蔗鮮奶（M）｜甘蔗200cc + 鮮奶160cc + RO；（不額外加糖）
甘蔗鮮奶（M+料）｜甘蔗140cc + 鮮奶120cc + RO；（不額外加糖）
阿華田鮮奶（L）｜阿華田3匙 + 鮮奶160cc + RO；（糖鍵奶香鍵）
阿華田鮮奶（M）｜阿華田2匙 + 鮮奶120cc + RO；（糖鍵奶香鍵）
阿華田鮮奶（M+料）｜阿華田1匙 + 鮮奶80cc + RO；（糖鍵奶香鍵）
錫蘭紅鮮奶（L）｜鮮奶180cc + 紅茶；（糖鍵奶香鍵）
錫蘭紅鮮奶（M）｜鮮奶140cc  + 紅茶；（糖鍵奶香鍵）
錫蘭紅鮮奶（M+料）｜鮮奶120cc + 紅茶；（糖鍵奶香鍵）
茉香綠鮮奶（L）｜鮮奶180cc + 綠茶；（糖鍵奶香鍵）
茉香綠鮮奶（M）｜鮮奶140cc  + 綠茶；（糖鍵奶香鍵）
茉香綠鮮奶（M+料）｜鮮奶120cc + 綠茶；（糖鍵奶香鍵）
文山青鮮奶（L）｜鮮奶180cc + 青茶；（糖鍵奶香鍵）
文山青鮮奶（M）｜鮮奶140cc  + 青茶；（糖鍵奶香鍵）
文山青鮮奶（M+料）｜鮮奶120cc + 青茶；（糖鍵奶香鍵）
鐵觀音鮮奶（L）｜鮮奶180cc + 鐵觀音；（糖鍵奶香鍵）
鐵觀音鮮奶（M）｜鮮奶140cc  + 鐵觀音；（糖鍵奶香鍵）
鐵觀音鮮奶（M+料）｜鮮奶120cc + 鐵觀音；（糖鍵奶香鍵）
玄米鮮奶（L）｜鮮奶180cc + 玄米；（糖鍵奶香鍵）
玄米鮮奶（M）｜鮮奶140cc  + 玄米；（糖鍵奶香鍵）
玄米鮮奶（M+料）｜鮮奶120cc + 玄米；（糖鍵奶香鍵）
冬瓜鮮奶（L）｜鮮奶160cc + 冬瓜茶；（不額外加糖）
冬瓜鮮奶（M）｜鮮奶120cc + 冬瓜茶；（不額外加糖）
可可鮮奶（L）｜可可2匙 + 鮮奶160cc + RO；（糖鍵奶香鍵）
可可鮮奶（M）｜可可1.5匙 + 鮮奶140cc + RO；（糖鍵奶香鍵）
芝麻鮮奶茶｜芝麻2匙 + 鮮奶140cc + 紅茶；（糖鍵奶香鍵）
錫蘭奶茶｜錫蘭奶茶；（糖鍵奶香鍵）
茉香奶茶（L）｜綠茶 + 奶精4匙；（糖鍵奶香鍵）
茉香奶茶（M）｜綠茶 + 奶精3匙；（糖鍵奶香鍵）
茉香奶茶（M+料）｜綠茶 + 奶精2匙；（糖鍵奶香鍵）
文山青奶茶（L）｜青茶 + 奶精4匙；（糖鍵奶香鍵）
文山青奶茶（M）｜青茶 + 奶精3匙；（糖鍵奶香鍵）
文山青奶茶（M+料）｜青茶 + 奶精2匙；（糖鍵奶香鍵）
鐵觀音奶茶（L）｜鐵觀音 + 奶精4匙；（糖鍵奶香鍵）
鐵觀音奶茶（M）｜鐵觀音 + 奶精3匙；（糖鍵奶香鍵）
鐵觀音奶茶（M+料）｜鐵觀音 + 奶精2匙；（糖鍵奶香鍵）
玄米奶茶（L）｜玄米 + 奶精4匙；（糖鍵奶香鍵）
玄米奶茶（M）｜玄米 + 奶精3匙；（糖鍵奶香鍵）
玄米奶茶（M+料）｜玄米 + 奶精2匙；（糖鍵奶香鍵）
紅豆波霸奶茶（L）｜紅豆 + 波霸 + 錫蘭奶茶；（糖鍵奶香鍵）
紅豆波霸奶茶（M+料）｜紅豆 + 波霸 + 錫蘭奶茶；（糖鍵奶香鍵）
可可奶茶（L）｜錫蘭奶茶 + 可可2匙；（糖鍵奶香鍵）
可可奶茶（M）｜錫蘭奶茶 + 可可1.5匙；（糖鍵奶香鍵）
可可奶茶（M+料）｜錫蘭奶茶 + 可可1匙；（糖鍵奶香鍵）
阿華田（L）｜RO + 阿華田3匙 + 奶精3匙；（糖鍵奶香鍵）
阿華田（M）｜RO + 阿華田2匙 + 奶精2匙；（糖鍵奶香鍵）
阿華田（M+料）｜RO + 阿華田1匙 + 奶精1匙；（糖鍵奶香鍵）
奶酪布丁奶茶（L）｜奶酪布丁 + 錫蘭奶茶；（糖鍵奶香鍵）
奶酪布丁奶茶（M+料）｜奶酪布丁 + 錫蘭奶茶；（糖鍵奶香鍵）
白鬍子奶蓋紅｜紅茶 + 奶蓋；（糖鍵紅茶鍵）
白鬍子奶蓋綠｜綠茶 + 奶蓋；（糖鍵原茶鍵）
白鬍子奶蓋青｜青茶 + 奶蓋；（糖鍵原茶鍵）
白鬍子奶蓋玄米｜玄米 + 奶蓋；（糖鍵原茶鍵）
白鬍子奶蓋鐵觀音｜鐵觀音 + 奶蓋；（糖鍵原茶鍵）
芝麻奶茶（L）｜芝麻粉2匙 + 錫蘭奶茶；（糖鍵奶香鍵）
芝麻奶茶（M）｜芝麻粉1.5匙 + 錫蘭奶茶；（糖鍵奶香鍵）
杏仁奶茶（L）｜杏仁粉2匙 + 錫蘭奶茶；（糖鍵奶香鍵）
杏仁奶茶（M）｜杏仁粉1.5匙 + 錫蘭奶茶；（糖鍵奶香鍵）
水蜜桃雪沙｜水蜜桃果粒50g + RO + 冰塊；（糖鍵冰沙鍵）
水蜜桃紅｜水蜜桃果粒100g + 紅茶；（糖鍵柳橙鍵）
水蜜桃綠｜水蜜桃果粒100g + 綠茶；（糖鍵柳橙鍵）
水蜜桃青｜水蜜桃果粒100g + 青茶；（糖鍵柳橙鍵）
蜜桃檸檬紅｜水蜜桃果粒100g + 檸檬10cc + 紅茶；（糖鍵柳橙鍵）
蜜桃檸檬綠｜水蜜桃果粒100g + 檸檬10cc + 綠茶；（糖鍵柳橙鍵）
蜜桃檸檬青｜水蜜桃果粒100g + 檸檬10cc + 青茶；（糖鍵柳橙鍵）
`;

/* ------------------ 工具 ------------------ */
function norm(s){
  if(!s) return null;
  let x = s.replace(/[+；;、。，（）()]/g,'').replace(/\s+/g,'').trim();
  if(!x || STOP_RE.test(x)) return null;
  x = x.replace(/^RO\d+$/,'RO').replace(/^冰塊.*$/,'冰塊');
  x = ALIASES[x] || x;
  if (EXCLUDE_OPTIONS.has(x)) return null;
  return x;
}
function cn2num(txt){
  const map={'零':0,'一':1,'二':2,'兩':2,'三':3,'四':4,'五':5,'六':6,'七':7,'八':8,'九':9,'十':10};
  if(/^\d+$/.test(txt)) return parseInt(txt,10);
  if(txt==='十') return 10;
  let m=txt.match(/^(十)([一二三四五六七八九])$/); if(m) return 10+map[m[2]];
  m=txt.match(/^([一二三四五六七八九])十([一二三四五六七八九])?$/); if(m) return map[m[1]]*10+(m[2]?map[m[2]]:0);
  m=txt.match(/^([一二三四五六七八九])$/); if(m) return map[m[1]];
  return NaN;
}
function extractFacts(text){
  const facts=[]; if(!text) return facts; let m;
  let re1=/([\u4e00-\u9fa5A-Za-z（）()\/]+?)\s*([0-9一二兩三四五六七八九十]+)\s*(cc|g|匙|顆|罐)/g;
  while((m=re1.exec(text))){
    const ing=norm(m[1]); if(!ing) continue;
    const num=cn2num(m[2]); const unit=m[3]; if(!isNaN(num)) facts.push({ingredient:ing,amount:num,unit});
  }
  let re2=/([0-9一二兩三四五六七八九十]+)\s*(cc|g|匙|顆|罐)\s*([\u4e00-\u9fa5A-Za-z（）()\/]+?)(?=[+；;、，\s]|$)/g;
  while((m=re2.exec(text))){
    const num=cn2num(m[1]); const unit=m[2]; const ing=norm(m[3]); if(!ing) continue;
    if(!isNaN(num)) facts.push({ingredient:ing,amount:num,unit});
  }
  let reRO=/RO\s*?(\d+)/g; while((m=reRO.exec(text))) facts.push({ingredient:'RO',amount:parseInt(m[1],10),unit:'cc'});
  const vocab=['RO','冰塊','紅茶','綠茶','青茶','鐵觀音','玄米','冬瓜茶','錫蘭奶茶','鮮奶','奶蓋',
               '蜂蜜','黑糖','奶精','阿華田','可可粉','芝麻粉','杏仁粉','芋泥','紅豆','杏仁凍',
               '百香','檸檬','金桔','柳橙','甘蔗汁','葡萄柚','奇亞籽','波霸','愛玉','蘆薈','仙草','奶酪布丁',
               '芒果','芒果丁','鳳梨','火龍果','奇異果','番茄','酪梨','酪梨火龍果','毛豆','水蜜桃','芭樂','多多'];
  const present=new Set(facts.map(f=>f.ingredient));
  vocab.forEach(v=>{ if(text.includes(v)){ const n=norm(v); if(n && !present.has(n)) facts.push({ingredient:n,amount:null,unit:''}) }});
  const seen={}; return facts.filter(f=>{ const k=f.ingredient+'|'+(f.amount??'')+'|'+(f.unit||''); if(seen[k]) return false; seen[k]=1; return true; });
}
const deck = lines.split(/\n+/).map(s=>s.trim()).filter(Boolean).map(s=>{ const p=s.split(/\s*[\|｜]\s*/); return {name:p[0],formula:p[1]||''}; });
const GLOBAL_POOL = Array.from(new Set(deck.flatMap(d=>extractFacts(d.formula).map(f=>f.ingredient)))).filter(x=>x && !EXCLUDE_OPTIONS.has(x));
const pick=a=>a[Math.floor(Math.random()*a.length)];
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }

function makeAmountQ(item){
  const facts=extractFacts(item.formula).filter(f=>f.unit);
  if(!facts.length) return null;
  const t=pick(facts);
  let wrongNums=[];
  if(t.unit==='罐' || t.unit==='匙'){
    const c=[t.amount-1,t.amount+1,t.amount+2,t.amount-2].filter(x=>x>0);
    wrongNums=Array.from(new Set(c)).slice(0,3);
  }else{
    const pool=[5,10,15,20,30,40,45,50,60,80,100,120,140,160,180,200,220,240,300];
    wrongNums=pool.filter(x=>x!==t.amount).sort((a,b)=>Math.abs(a-t.amount)-Math.abs(b-t.amount)).slice(0,3);
  }
  const options=shuffle([`${t.amount}${t.unit}`, ...wrongNums.map(n=>`${n}${t.unit}`)]);
  return {type:'amount', stem:`「${item.name}」中，<b>${t.ingredient}</b> 用量是多少？`, options, answer:`${t.amount}${t.unit}`, explain:`完整配方：${item.formula}`};
}
function makeMultiQ(item){
  const facts=extractFacts(item.formula);
  let present=Array.from(new Set(facts.map(f=>f.ingredient))).filter(Boolean).filter(x=>!EXCLUDE_OPTIONS.has(x));
  if(present.length<2) return null;
  const correctCount=Math.min(4, Math.max(2, Math.min(present.length,4)));
  const correctOpts=shuffle(present).slice(0,correctCount);
  const distract=GLOBAL_POOL.filter(x=>!correctOpts.includes(x));
  const wrongNeed=Math.max(0, 5 - correctOpts.length);
  const wrongOpts=shuffle(distract).slice(0,wrongNeed);
  const options=shuffle([...correctOpts,...wrongOpts]);
  return {type:'multi', stem:`請勾選「${item.name}」的所有正確成分（多選）。`, options, answers:new Set(correctOpts), explain:`完整：${item.formula}`};
}
function buildOne(mode){
  let q=null, guard=0;
  while(!q && guard++<400){
    const it=pick(deck);
    const t = (mode==='mixed') ? (Math.random()<0.5?'amount':'multi') : mode;
    q = (t==='amount') ? makeAmountQ(it) : makeMultiQ(it);
  }
  return q;
}

/* ---- 渲染/評分 ---- */
let paper=[], idx=0, score=0, answered=false;

function genPaper(){
  const mode=document.getElementById('mode').value;
  paper=[]; const seen=new Set();
  while(paper.length<TOTAL){
    const q=buildOne(mode); if(!q) continue;
    const k=q.stem+'|'+(q.answer||Array.from(q.answers||[]).join(','));
    if(seen.has(k)) continue; seen.add(k); paper.push(q);
  }
}

function updateMeta(){
  const done=Math.min(idx+(answered?1:0),TOTAL);
  document.getElementById('meta').textContent=`進度：${done}/${TOTAL}｜得分：${(Math.round(score*10)/10).toFixed(1)}/${TOTAL*POINT}`;
}
function enableSubmitIfAnySelection(){
  const box=document.getElementById('options');
  const has = !!box.querySelector('input:checked');
  document.getElementById('submit').disabled = !has || answered;
}

function render(){
  const submitBtn=document.getElementById('submit');
  const nextBtn=document.getElementById('next');
  submitBtn.disabled=true; nextBtn.disabled=true;

  if(idx>=paper.length){ return showSummary(); }

  const q=paper[idx];
  const box=document.getElementById('options'); box.innerHTML='';
  document.getElementById('card').style.display='block';
  document.getElementById('summary').style.display='none';
  document.getElementById('q').innerHTML=`第 ${idx+1} / ${TOTAL} 題｜${q.stem}`;
  answered=false;

  if(q.type==='amount'){
    q.options.forEach((t,i)=>{
      const div=document.createElement('label');
      div.className='opt';
      div.innerHTML=`<input type="radio" name="opt"><b>${'ABCDE'[i]})</b> ${t}`;
      div.querySelector('input').addEventListener('change', enableSubmitIfAnySelection);
      box.appendChild(div);
    });
  }else{
    q.options.forEach((t,i)=>{
      const div=document.createElement('label');
      div.className='opt';
      div.innerHTML=`<input type="checkbox"><b>${'ABCDE'[i]})</b> ${t}`;
      div.querySelector('input').addEventListener('change', enableSubmitIfAnySelection);
      box.appendChild(div);
    });
  }
  document.getElementById('explain').textContent='';
  enableSubmitIfAnySelection();
  updateMeta();
}

function gradeCurrent(){
  if(answered) return;
  const q=paper[idx];
  const box=document.getElementById('options');
  const nodes=[...box.children];

  if(q.type==='amount'){
    const checkedIdx = nodes.findIndex(n=>n.querySelector('input').checked);
    if(checkedIdx<0) return;
    const chosen = q.options[checkedIdx];
    const ansIdx = q.options.indexOf(q.answer);
    nodes[ansIdx].classList.add('correct');
    if(chosen!==q.answer) nodes[checkedIdx].classList.add('wrong');
    if(chosen===q.answer) score+=POINT;
    answered=true;
  }else{
    const chosen=new Set(nodes.map((n,i)=> n.querySelector('input').checked ? q.options[i] : null).filter(Boolean));
    let correctChosen=0, wrongChosen=0;
    nodes.forEach((n,i)=>{
      const opt=q.options[i], right=q.answers.has(opt), checked=chosen.has(opt);
      if(right){
        n.classList.add('correct');
        if(!checked) n.classList.add('missed'); else correctChosen++;
      }else{
        if(checked){ n.classList.add('wrong'); wrongChosen++; }
      }
    });
    const unit = POINT / q.answers.size;
    const gain = Math.max(0, correctChosen*unit - wrongChosen*unit);
    score += Math.round(gain*10)/10;
    answered=true;
  }
  document.getElementById('explain').textContent=q.explain;
  document.getElementById('submit').disabled=true;
  document.getElementById('next').disabled=false;
  updateMeta();
}

function showSummary(){
  const s=document.getElementById('summary'); s.style.display='block';
  const final = (Math.round(score*10)/10).toFixed(1);     // ← 四捨五入到小數點一位
  s.innerHTML=`
    <div class="final-score"><b>本次成績：${final} 分</b>（滿分 ${TOTAL*POINT}）</div>
    <button id="retry" class="btn-primary" style="margin-top:10px">再試一次</button>`;
  document.getElementById('card').style.display='none';
  document.getElementById('retry').onclick=startExam;
}
function startExam(){ idx=0; score=0; answered=false; genPaper(); render(); }

/* ---- 背景輪播 ---- */
(function slideshow(){
  const A=document.getElementById('bgA'), B=document.getElementById('bgB');
  let i=0, useA=true;
  const set=(el,url)=>{ el.style.backgroundImage=`url('${url}')`; };
  set(A,BG_LIST[0]); set(B,BG_LIST[1]); B.classList.add('hidden');
  setInterval(()=>{
    i = (i+1)%BG_LIST.length;
    if(useA){ set(B, BG_LIST[i]); B.classList.remove('hidden'); A.classList.add('hidden'); }
    else{ set(A, BG_LIST[i]); A.classList.remove('hidden'); B.classList.add('hidden'); }
    useA=!useA;
  }, BG_INTERVAL);
})();

/* ---- 綁定 ---- */
document.getElementById('start').onclick=startExam;
document.getElementById('submit').onclick=gradeCurrent;
document.getElementById('next').onclick=()=>{ if(!answered) return; idx++; render(); };
</script>
</body>
</html>